<%- include("template/header") %>
<%- include("template/navbar") %>
<%- include("template/aside") %> 

<!-- Content Wrapper -->
<div class="content-wrapper">
  <%- include('template/breadcrumb', {module: 'Gestión de Proyectos'}) %>
  
  <!-- Content Header -->
  <section class="content-header">
    <div class="container-fluid">
      <!-- TARJETA PRINCIPAL INTRO -->
      <div class="row mb-4">
        <div class="col-md-12">
          <div class="card border-0 shadow-lg" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); border-radius: 15px;">
            <div class="card-body text-white p-5">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <div style="font-size: 3rem; margin-right: 20px;">
                    <i class="fas fa-tasks"></i>
                  </div>
                  <div>
                    <h2 class="card-title mb-2" style="font-weight: 700;">Gestión de Proyectos</h2>
                    <p class="mb-0 text-white-50">Registra y administra todos tus proyectos con descripción detallada.</p>
                  </div>
                </div>
                <button class="btn btn-primary btn-lg" onclick="abrirModalNuevoProyecto()" style="font-weight: 600;">
                  <i class="fas fa-plus mr-2"></i> Nuevo Proyecto
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ESTADÍSTICAS -->
      <div class="row mb-4" id="estadisticasProyectos">
        <div class="col-lg-3 col-md-6 mb-2">
          <div class="card border-0 shadow-sm text-center p-3">
            <div style="font-size: 2.5rem; color: #8b5cf6; margin-bottom: 10px;">
              <i class="fas fa-cube"></i>
            </div>
            <h3 id="totalProyectos" class="mb-1" style="font-weight: 700;">0</h3>
            <p class="text-muted mb-0">Total Proyectos</p>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-2">
          <div class="card border-0 shadow-sm text-center p-3">
            <div style="font-size: 2.5rem; color: #3b82f6; margin-bottom: 10px;">
              <i class="fas fa-play"></i>
            </div>
            <h3 id="enEjecucion" class="mb-1" style="font-weight: 700;">0</h3>
            <p class="text-muted mb-0">En Ejecución</p>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-2">
          <div class="card border-0 shadow-sm text-center p-3">
            <div style="font-size: 2.5rem; color: #10b981; margin-bottom: 10px;">
              <i class="fas fa-check-circle"></i>
            </div>
            <h3 id="finalizados" class="mb-1" style="font-weight: 700;">0</h3>
            <p class="text-muted mb-0">Finalizados</p>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-2">
          <div class="card border-0 shadow-sm text-center p-3">
            <div style="font-size: 2.5rem; color: #f59e0b; margin-bottom: 10px;">
              <i class="fas fa-pause-circle"></i>
            </div>
            <h3 id="enPausa" class="mb-1" style="font-weight: 700;">0</h3>
            <p class="text-muted mb-0">En Pausa</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Main content -->
  <section class="content">
    <div class="container-fluid">
      <!-- FILTRO DE ESTADOS -->
      <div class="row mb-3">
        <div class="col-md-12">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <label class="font-weight-600 mb-2">Filtrar por estado:</label>
              <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm btn-outline-primary active" onclick="filtrarProyectos('todos')">Todos</button>
                <button type="button" class="btn btn-sm btn-outline-info" onclick="filtrarProyectos('En Ejecución')">En Ejecución</button>
                <button type="button" class="btn btn-sm btn-outline-success" onclick="filtrarProyectos('Finalizado')">Finalizados</button>
                <button type="button" class="btn btn-sm btn-outline-warning" onclick="filtrarProyectos('Pausa')">En Pausa</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- LISTA DE PROYECTOS -->
      <div class="row" id="contenedorProyectos">
        <div class="col-md-12">
          <div class="card border-0 shadow-sm text-center p-5">
            <div class="spinner-border text-primary" role="status">
              <span class="sr-only">Cargando...</span>
            </div>
            <p class="mt-3 text-muted">Cargando proyectos...</p>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<%- include("template/footer") %>

<script>
  let proyectosData = [];
  let filtroActual = 'todos';
  let supervisoresData = [];

  document.addEventListener('DOMContentLoaded', function() {
    cargarSupervisores();
    cargarProyectos();
    
    // Manejar cambios de hash para tabs
    window.addEventListener('hashchange', activarTabDesdeHash);
    
    // Activar tab desde hash si existe al cargar
    if (window.location.hash) {
      setTimeout(activarTabDesdeHash, 500);
    }
  });

  function activarTabDesdeHash() {
    const hash = window.location.hash.substring(1); // Remover el #
    if (!hash) return;
    
    // Buscar el link del tab correspondiente
    const tabLink = document.querySelector(`a[href="#${hash}"]`);
    if (tabLink) {
      // Usar Bootstrap para activar el tab
      $(tabLink).tab('show');
      
      // Cargar datos si es tab de hitos o actividades
      setTimeout(() => {
        if (hash.includes('-hitos')) {
          const proyecto_id = hash.replace('proyecto-', '').replace('-hitos', '');
          cargarHitosEnTab(proyecto_id);
        } else if (hash.includes('-actividades')) {
          const proyecto_id = hash.replace('proyecto-', '').replace('-actividades', '');
          cargarActividadesEnTab(proyecto_id);
        }
      }, 100);
      
      // Scroll al proyecto
      const proyectoCard = tabLink.closest('.card');
      if (proyectoCard) {
        proyectoCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }
  }

  function cargarSupervisores() {
    fetch('/api/supervisores', { credentials: 'include' })
      .then(response => response.json())
      .then(data => {
        if (data.success && Array.isArray(data.supervisores)) {
          supervisoresData = data.supervisores;
        }
      })
      .catch(error => console.error('Error al cargar supervisores:', error));
  }

  function cargarProyectos() {
    fetch('/api/proyectos', { credentials: 'include' })
      .then(response => response.json())
      .then(data => {
        if (data.success && Array.isArray(data.data)) {
          proyectosData = data.data;
          actualizarEstadisticas();
          mostrarProyectos(proyectosData);
        } else {
          document.getElementById('contenedorProyectos').innerHTML = `
            <div class="col-md-12">
              <div class="alert alert-warning text-center">
                <i class="fas fa-exclamation-circle mr-2"></i>No hay proyectos registrados
              </div>
            </div>
          `;
        }
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('contenedorProyectos').innerHTML = `
          <div class="col-md-12">
            <div class="alert alert-danger text-center">
              <i class="fas fa-exclamation-triangle mr-2"></i>Error al cargar los proyectos
            </div>
          </div>
        `;
      });
  }

  function actualizarEstadisticas() {
    const total = proyectosData.length;
    const enEjecucion = proyectosData.filter(p => p.estado === 'En Ejecución').length;
    const finalizados = proyectosData.filter(p => p.estado === 'Finalizado').length;
    const enPausa = proyectosData.filter(p => p.estado === 'Pausa').length;

    document.getElementById('totalProyectos').textContent = total;
    document.getElementById('enEjecucion').textContent = enEjecucion;
    document.getElementById('finalizados').textContent = finalizados;
    document.getElementById('enPausa').textContent = enPausa;
  }

  function mostrarProyectos(proyectos) {
    let html = '<div class="row">';

    proyectos.forEach((proyecto, index) => {
      const colorEstado = obtenerColorEstado(proyecto.estado);
      const tabId = `proyecto-${proyecto.id}`;

      html += `
        <div class="col-lg-6 col-md-12 mb-3">
          <div class="card border-0 shadow" style="border-radius: 12px;">
            <div style="background: ${colorEstado}; padding: 20px; color: white; border-radius: 12px 12px 0 0;">
              <div class="d-flex justify-content-between">
                <h5 style="font-weight: 700; margin: 0;">${proyecto.nombre_proyecto}</h5>
                <span class="badge badge-light">${proyecto.estado}</span>
              </div>
            </div>

            <div class="card-body p-3">
              <!-- TABS DENTRO DE LA TARJETA -->
              <ul class="nav nav-tabs nav-sm mb-2" role="tablist">
                <li class="nav-item">
                  <a class="nav-link active" data-toggle="tab" href="#${tabId}-info" onclick="window.location.hash='${tabId}-info'; return false;">
                    <small><i class="fas fa-info-circle mr-1"></i>Info</small>
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" data-toggle="tab" href="#${tabId}-hitos" onclick="window.location.hash='${tabId}-hitos'; setTimeout(() => cargarHitosEnTab(${proyecto.id}), 100);">
                    <small><i class="fas fa-flag mr-1"></i>Hitos</small>
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" data-toggle="tab" href="#${tabId}-actividades" onclick="window.location.hash='${tabId}-actividades'; setTimeout(() => cargarActividadesEnTab(${proyecto.id}), 100);">
                    <small><i class="fas fa-tasks mr-1"></i>Actividades</small>
                  </a>
                </li>
              </ul>

              <div class="tab-content small">
                <!-- INFO TAB -->
                <div id="${tabId}-info" class="tab-pane fade show active">
                  <p class="mb-1"><strong>Cliente:</strong> ${proyecto.cliente}</p>
                  <p class="mb-1"><strong>Encargado:</strong> ${proyecto.encargado || 'Sin asignar'}</p>
                  <p class="mb-2">${proyecto.descripcion || 'Sin descripción'}</p>
                  <div class="mb-2">
                    <small class="text-muted">Avance: ${proyecto.porcentaje_avance || 0}%</small>
                    <div class="progress progress-sm">
                      <div class="progress-bar" style="width: ${proyecto.porcentaje_avance || 0}%"></div>
                    </div>
                  </div>
                  <small class="text-muted">Presupuesto: $${parseFloat(proyecto.presupuesto_estimado || 0).toLocaleString('es-MX')}</small><br>
                  <small class="text-muted">Horas: ${proyecto.horas_invertidas || 0} / ${proyecto.horas_estimadas || 0}</small>
                  <div class="mt-3">
                    <button class="btn btn-xs btn-warning" onclick="editarProyecto(${proyecto.id}, '${proyecto.nombre_proyecto.replace(/'/g, "&apos;")}')">
                      <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-xs btn-danger" onclick="eliminarProyecto(${proyecto.id}, '${proyecto.nombre_proyecto.replace(/'/g, "&apos;")}')">
                      <i class="fas fa-trash"></i> Eliminar
                    </button>
                  </div>
                </div>

                <!-- HITOS TAB -->
                <div id="${tabId}-hitos" class="tab-pane fade">
                  <div id="hitos-${proyecto.id}" class="text-center">
                    <small class="text-muted">Cargando hitos...</small>
                  </div>
                  <button class="btn btn-xs btn-primary mt-2" onclick="abrirModalNuevoHito(${proyecto.id})">
                    <i class="fas fa-plus"></i> Nuevo Hito
                  </button>
                </div>

                <!-- ACTIVIDADES TAB -->
                <div id="${tabId}-actividades" class="tab-pane fade">
                  <div id="actividades-${proyecto.id}" class="text-center">
                    <small class="text-muted">Cargando actividades...</small>
                  </div>
                  <button class="btn btn-xs btn-primary mt-2" onclick="abrirModalNuevaActividad(${proyecto.id})">
                    <i class="fas fa-plus"></i> Nueva Actividad
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    });

    html += '</div>';
    document.getElementById('contenedorProyectos').innerHTML = html;

    // Cargar hitos y actividades para cada proyecto
    proyectos.forEach(proyecto => {
      cargarHitosEnTab(proyecto.id);
      cargarActividadesEnTab(proyecto.id);
    });
  }

  function obtenerColorEstado(estado) {
    const colores = {
      'Levantamiento': 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)',
      'Cotización': 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
      'Aprobado': 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
      'En Ejecución': 'linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%)',
      'Pausa': 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
      'Finalizado': 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
      'Cancelado': 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'
    };
    return colores[estado] || 'linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%)';
  }

  function cargarHitosEnTab(proyecto_id) {
    console.log('Cargando hitos para proyecto:', proyecto_id);
    fetch(`/api/hitos?proyecto_id=${proyecto_id}`, { credentials: 'include' })
      .then(r => {
        console.log('Response status:', r.status);
        return r.json();
      })
      .then(data => {
        console.log('Data recibida:', data);
        const hitos = data.data || [];
        let html = '';
        
        if (hitos.length === 0) {
          html = '<p class="text-muted">Sin hitos</p>';
        } else {
          hitos.forEach(hito => {
            const progreso = hito.total_actividades > 0 
              ? Math.round((hito.actividades_completadas / hito.total_actividades) * 100)
              : 0;
            
            html += `
              <div class="card mb-2 border-left-${obtenerColorBorde(hito.estado)}">
                <div class="card-body p-2">
                  <div class="d-flex justify-content-between align-items-start">
                    <div style="flex: 1;">
                      <strong>${hito.nombre}</strong>
                      <div class="small text-muted">
                        ${hito.fecha_objetivo ? new Date(hito.fecha_objetivo).toLocaleDateString('es-MX') : 'Sin fecha'}
                        ${hito.descripcion ? '<br>' + hito.descripcion.substring(0, 50) + '...' : ''}
                      </div>
                    </div>
                    <span class="badge badge-${obtenerBadgeEstado(hito.estado)}">${hito.estado}</span>
                  </div>
                  <div class="small mt-2 mb-2">
                    <div class="progress progress-xs">
                      <div class="progress-bar" style="width: ${progreso}%"></div>
                    </div>
                    <small class="text-muted">${hito.actividades_completadas}/${hito.total_actividades} actividades</small>
                  </div>
                  <div class="mt-2">
                    <button class="btn btn-xs btn-primary" onclick="editarHito(${hito.id})" title="Editar">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-xs btn-danger" onclick="eliminarHito(${hito.id})" title="Eliminar">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            `;
          });
        }
        
        const targetElement = document.getElementById(`hitos-${proyecto_id}`);
        console.log('Target element:', targetElement);
        if (targetElement) {
          targetElement.innerHTML = html;
        } else {
          console.error('No se encontró elemento hitos-' + proyecto_id);
        }
      })
      .catch(error => console.error('Error cargando hitos:', error));
  }

  function cargarActividadesEnTab(proyecto_id) {
    console.log('Cargando actividades para proyecto:', proyecto_id);
    fetch(`/api/actividades?proyecto_id=${proyecto_id}`, { credentials: 'include' })
      .then(r => {
        console.log('Response status:', r.status);
        return r.json();
      })
      .then(data => {
        console.log('Data recibida:', data);
        const actividades = data.data || [];
        let html = '';
        
        if (actividades.length === 0) {
          html = '<p class="text-muted">Sin actividades</p>';
        } else {
          html = '<div style="max-height: 300px; overflow-y: auto;">';
          actividades.forEach(actividad => {
            const porcentajeAvance = actividad.horas_estimadas > 0
              ? Math.round((actividad.horas_invertidas / actividad.horas_estimadas) * 100)
              : 0;
            
            html += `
              <div class="card mb-2 border-left-${obtenerColorBorde(actividad.estado)}">
                <div class="card-body p-2">
                  <div class="d-flex justify-content-between align-items-start">
                    <div style="flex: 1;">
                      <strong>${actividad.titulo}</strong>
                      <div class="small text-muted">
                        Responsable: ${actividad.responsable_nombre || 'Sin asignar'}
                        ${actividad.fecha_vencimiento ? '<br>Vencimiento: ' + new Date(actividad.fecha_vencimiento).toLocaleDateString('es-MX') : ''}
                      </div>
                    </div>
                    <span class="badge badge-${obtenerBadgeEstado(actividad.estado)}">${actividad.estado}</span>
                  </div>
                  <div class="small mt-2">
                    <span class="badge badge-info">${actividad.prioridad}</span>
                    <span class="ml-2">Horas: ${actividad.horas_invertidas}/${actividad.horas_estimadas}</span>
                  </div>
                  ${actividad.horas_estimadas > 0 ? `
                    <div class="progress progress-xs mt-1">
                      <div class="progress-bar" style="width: ${porcentajeAvance}%"></div>
                    </div>
                  ` : ''}
                  <div class="mt-2">
                    <button class="btn btn-xs btn-primary" onclick="editarActividad(${actividad.id})" title="Editar">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-xs btn-danger" onclick="eliminarActividad(${actividad.id})" title="Eliminar">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            `;
          });
          html += '</div>';
        }
        
        const targetElement = document.getElementById(`actividades-${proyecto_id}`);
        console.log('Target element:', targetElement);
        if (targetElement) {
          targetElement.innerHTML = html;
        } else {
          console.error('No se encontró elemento actividades-' + proyecto_id);
        }
      })
      .catch(error => console.error('Error cargando actividades:', error));
  }

  function obtenerBadgeEstado(estado) {
    const badges = {
      'Pendiente': 'secondary',
      'En Progreso': 'info',
      'En Revisión': 'warning',
      'Completada': 'success',
      'No iniciado': 'secondary',
      'En progreso': 'info',
      'Completado': 'success',
      'Retrasado': 'danger'
    };
    return badges[estado] || 'secondary';
  }

  function obtenerColorBorde(estado) {
    const colores = {
      'Pendiente': 'primary',
      'En Progreso': 'info',
      'En Revisión': 'warning',
      'Completada': 'success',
      'No iniciado': 'secondary',
      'En progreso': 'info',
      'Completado': 'success',
      'Retrasado': 'danger'
    };
    return colores[estado] || 'primary';
  }

  function filtrarProyectos(filtro) {
    filtroActual = filtro;
    
    let proyectosFiltrados = proyectosData;
    if (filtro !== 'todos') {
      proyectosFiltrados = proyectosData.filter(p => p.estado === filtro);
    }

    mostrarProyectos(proyectosFiltrados);
  }

  function abrirModalNuevoProyecto() {
    let htmlSupervisores = supervisoresData.map(s => `<option value="${s.id}">${s.nombre_supervisor}</option>`).join('');

    Swal.fire({
      title: '<strong>Nuevo Proyecto</strong>',
      html: `
        <div class="text-left">
          <div class="form-group mb-3">
            <label class="font-weight-600">Nombre del Proyecto:</label>
            <input type="text" id="nombreProyecto" class="form-control" placeholder="Ingresa el nombre">
          </div>
          <div class="form-group mb-3">
            <label class="font-weight-600">Cliente:</label>
            <input type="text" id="clienteProyecto" class="form-control" placeholder="Ingresa el cliente">
          </div>
          <div class="form-group mb-3">
            <label class="font-weight-600">Descripción:</label>
            <textarea id="descripcionProyecto" class="form-control" rows="3" placeholder="Describe el proyecto..."></textarea>
          </div>
          <div class="form-group mb-3">
            <label class="font-weight-600">Presupuesto Estimado:</label>
            <input type="number" id="presupuestoProyecto" class="form-control" placeholder="0.00" step="0.01">
          </div>
          <div class="form-group mb-3">
            <label class="font-weight-600">Supervisor (Encargado):</label>
            <select id="supervisorProyecto" class="form-control" onchange="cargarEmpleadosSupervisor()">
              <option value="">Selecciona un supervisor...</option>
              ${htmlSupervisores}
            </select>
          </div>
          <div class="form-group mb-3">
            <label class="font-weight-600">Empleados que Participan:</label>
            <div id="empleadosProyecto" class="border rounded p-2" style="max-height: 200px; overflow-y: auto; background-color: #f8f9fa;">
              <small class="text-muted">Selecciona un supervisor primero</small>
            </div>
          </div>
        </div>
      `,
      icon: 'info',
      showCancelButton: true,
      confirmButtonColor: '#10b981',
      cancelButtonColor: '#6c757d',
      confirmButtonText: '<i class="fas fa-save mr-2"></i>Crear Proyecto',
      cancelButtonText: 'Cancelar',
      width: '600px'
    }).then((result) => {
      if (result.isConfirmed) {
        guardarNuevoProyecto();
      }
    });
  }

  function cargarEmpleadosSupervisor() {
    const supervisorId = document.getElementById('supervisorProyecto').value;
    const contenedor = document.getElementById('empleadosProyecto');

    if (!supervisorId) {
      contenedor.innerHTML = '<small class="text-muted">Selecciona un supervisor primero</small>';
      return;
    }

    const supervisor = supervisoresData.find(s => s.id == supervisorId);
    if (!supervisor || !supervisor.empleados || supervisor.empleados.length === 0) {
      contenedor.innerHTML = '<small class="text-danger">Este supervisor no tiene empleados asignados</small>';
      return;
    }

    let html = '<div class="list-group">';
    supervisor.empleados.forEach(emp => {
      html += `
        <label class="list-group-item">
          <input type="checkbox" class="empleado-checkbox" value="${emp.id}" data-nombre="${emp.nombre}">
          <span>${emp.nombre} - ${emp.puesto}</span>
        </label>
      `;
    });
    html += '</div>';
    contenedor.innerHTML = html;
  }

  function guardarNuevoProyecto() {
    const nombre = document.getElementById('nombreProyecto').value;
    const cliente = document.getElementById('clienteProyecto').value;
    const descripcion = document.getElementById('descripcionProyecto').value;
    const presupuesto = document.getElementById('presupuestoProyecto').value;
    const supervisorId = document.getElementById('supervisorProyecto').value;

    if (!nombre || !cliente) {
      Swal.fire('Error', 'Nombre y cliente son requeridos', 'error');
      return;
    }

    const empleadosSeleccionados = Array.from(document.querySelectorAll('.empleado-checkbox:checked')).map(e => e.value);

    fetch('/api/proyectos', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        nombre_proyecto: nombre,
        cliente,
        descripcion,
        presupuesto_estimado: presupuesto || 0,
        encargado_id: supervisorId || null,
        empleados_participantes: empleadosSeleccionados
      })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          Swal.fire('Éxito', 'Proyecto creado correctamente', 'success').then(() => {
            cargarProyectos();
          });
        } else {
          Swal.fire('Error', data.message || 'No se pudo crear el proyecto', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error', 'Error al crear el proyecto', 'error');
      });
  }

  function editarProyecto(id, nombre) {
    const proyecto = proyectosData.find(p => p.id === id);
    if (!proyecto) return;

    let htmlSupervisores = supervisoresData.map(s => `<option value="${s.id}" ${proyecto.encargado_id == s.id ? 'selected' : ''}>${s.nombre_supervisor}</option>`).join('');

    Swal.fire({
      title: `<strong>Editar: ${nombre}</strong>`,
      html: `
        <div class="text-left">
          <div class="form-group mb-3">
            <label class="font-weight-600">Nombre:</label>
            <input type="text" id="editNombreProyecto" class="form-control" value="${proyecto.nombre_proyecto}">
          </div>
          <div class="form-group mb-3">
            <label class="font-weight-600">Descripción:</label>
            <textarea id="editDescripcionProyecto" class="form-control" rows="3">${proyecto.descripcion || ''}</textarea>
          </div>
          <div class="form-group mb-3">
            <label class="font-weight-600">Estado:</label>
            <select id="editEstadoProyecto" class="form-control">
              <option value="Levantamiento" ${proyecto.estado === 'Levantamiento' ? 'selected' : ''}>Levantamiento</option>
              <option value="Cotización" ${proyecto.estado === 'Cotización' ? 'selected' : ''}>Cotización</option>
              <option value="Aprobado" ${proyecto.estado === 'Aprobado' ? 'selected' : ''}>Aprobado</option>
              <option value="En Ejecución" ${proyecto.estado === 'En Ejecución' ? 'selected' : ''}>En Ejecución</option>
              <option value="Pausa" ${proyecto.estado === 'Pausa' ? 'selected' : ''}>Pausa</option>
              <option value="Finalizado" ${proyecto.estado === 'Finalizado' ? 'selected' : ''}>Finalizado</option>
              <option value="Cancelado" ${proyecto.estado === 'Cancelado' ? 'selected' : ''}>Cancelado</option>
            </select>
          </div>
          <div class="form-group mb-3">
            <label class="font-weight-600">Porcentaje Avance:</label>
            <input type="number" id="editAvanceProyecto" class="form-control" value="${proyecto.porcentaje_avance || 0}" min="0" max="100">
          </div>
          <div class="form-group mb-3">
            <label class="font-weight-600">Supervisor:</label>
            <select id="editSupervisorProyecto" class="form-control">
              <option value="">Sin supervisor</option>
              ${htmlSupervisores}
            </select>
          </div>
        </div>
      `,
      icon: 'info',
      showCancelButton: true,
      confirmButtonColor: '#f59e0b',
      cancelButtonColor: '#6c757d',
      confirmButtonText: '<i class="fas fa-save mr-2"></i>Guardar Cambios',
      cancelButtonText: 'Cancelar',
      width: '600px'
    }).then((result) => {
      if (result.isConfirmed) {
        actualizarProyecto(id);
      }
    });
  }

  function actualizarProyecto(id) {
    const nombre = document.getElementById('editNombreProyecto').value;
    const descripcion = document.getElementById('editDescripcionProyecto').value;
    const estado = document.getElementById('editEstadoProyecto').value;
    const avance = document.getElementById('editAvanceProyecto').value;
    const supervisorId = document.getElementById('editSupervisorProyecto').value;

    fetch(`/api/proyectos/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        nombre_proyecto: nombre,
        descripcion,
        estado,
        porcentaje_avance: avance,
        encargado_id: supervisorId || null
      })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          Swal.fire('Éxito', 'Proyecto actualizado correctamente', 'success').then(() => {
            cargarProyectos();
          });
        } else {
          Swal.fire('Error', data.message || 'No se pudo actualizar el proyecto', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error', 'Error al actualizar el proyecto', 'error');
      });
  }

  function eliminarProyecto(id, nombre) {
    Swal.fire({
      title: '¿Eliminar proyecto?',
      html: `<p>Vas a eliminar: <strong>${nombre}</strong></p>
             <p class="text-danger">Esta acción no se puede deshacer</p>`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#dc3545',
      cancelButtonColor: '#6c757d',
      confirmButtonText: '<i class="fas fa-trash mr-2"></i>Sí, eliminar',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        fetch(`/api/proyectos/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              Swal.fire('Eliminado', 'Proyecto eliminado correctamente', 'success').then(() => {
                cargarProyectos();
              });
            } else {
              Swal.fire('Error', data.message || 'No se pudo eliminar el proyecto', 'error');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            Swal.fire('Error', 'Error al eliminar el proyecto', 'error');
          });
      }
    });
  }

  function abrirModalNuevoHito(proyecto_id) {
    Swal.fire({
      title: 'Nuevo Hito',
      html: `
        <div class="text-left">
          <div class="form-group">
            <label>Nombre</label>
            <input type="text" id="nombreHito" class="form-control" placeholder="Nombre del hito">
          </div>
          <div class="form-group">
            <label>Fecha Objetivo</label>
            <input type="date" id="fechaHito" class="form-control">
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: 'Crear'
    }).then(result => {
      if (result.isConfirmed) {
        const nombre = document.getElementById('nombreHito').value;
        const fecha = document.getElementById('fechaHito').value;

        if (!nombre || !fecha) {
          Swal.fire('Error', 'Nombre y fecha son requeridos', 'error');
          return;
        }

        fetch('/api/hitos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ proyecto_id, nombre, fecha_objetivo: fecha })
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            Swal.fire('Éxito', 'Hito creado', 'success');
            cargarHitosEnTab(proyecto_id);
            cargarProyectos();
          }
        });
      }
    });
  }

  function abrirModalNuevaActividad(proyecto_id) {
    Swal.fire({
      title: 'Nueva Actividad',
      html: `
        <div class="text-left">
          <div class="form-group">
            <label>Título</label>
            <input type="text" id="tituloActividad" class="form-control" placeholder="Título de la actividad">
          </div>
          <div class="form-group">
            <label>Prioridad</label>
            <select id="prioridadActividad" class="form-control">
              <option>Baja</option>
              <option selected>Media</option>
              <option>Alta</option>
              <option>Urgente</option>
            </select>
          </div>
          <div class="form-group">
            <label>Horas Estimadas</label>
            <input type="number" id="horasActividad" class="form-control" placeholder="0" step="0.5" min="0">
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: 'Crear'
    }).then(result => {
      if (result.isConfirmed) {
        const titulo = document.getElementById('tituloActividad').value;
        const prioridad = document.getElementById('prioridadActividad').value;
        const horas = document.getElementById('horasActividad').value;

        if (!titulo) {
          Swal.fire('Error', 'Título es requerido', 'error');
          return;
        }

        fetch('/api/actividades', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ proyecto_id, titulo, prioridad, horas_estimadas: horas || 0 })
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            Swal.fire('Éxito', 'Actividad creada', 'success');
            cargarActividadesEnTab(proyecto_id);
            cargarProyectos();
          }
        });
      }
    });
  }

  function editarHito(id) {
    // Obtener datos del hito
    fetch(`/api/hitos/${id}`, { credentials: 'include' })
      .then(r => r.json())
      .then(data => {
        if (!data.success) {
          Swal.fire('Error', 'No se pudo cargar el hito', 'error');
          return;
        }

        const hito = data.data;
        const proyecto_id = hito.proyecto_id;

        Swal.fire({
          title: `Editar Hito: ${hito.nombre}`,
          html: `
            <div class="text-left">
              <div class="form-group">
                <label>Nombre</label>
                <input type="text" id="editNombreHito" class="form-control" value="${hito.nombre}">
              </div>
              <div class="form-group">
                <label>Descripción</label>
                <textarea id="editDescripcionHito" class="form-control" rows="2">${hito.descripcion || ''}</textarea>
              </div>
              <div class="form-group">
                <label>Fecha Objetivo</label>
                <input type="date" id="editFechaHito" class="form-control" value="${hito.fecha_objetivo ? hito.fecha_objetivo.split(' ')[0] : ''}">
              </div>
              <div class="form-group">
                <label>Estado</label>
                <select id="editEstadoHito" class="form-control">
                  <option value="No iniciado" ${hito.estado === 'No iniciado' ? 'selected' : ''}>No iniciado</option>
                  <option value="En progreso" ${hito.estado === 'En progreso' ? 'selected' : ''}>En progreso</option>
                  <option value="Completado" ${hito.estado === 'Completado' ? 'selected' : ''}>Completado</option>
                  <option value="Retrasado" ${hito.estado === 'Retrasado' ? 'selected' : ''}>Retrasado</option>
                </select>
              </div>
            </div>
          `,
          showCancelButton: true,
          confirmButtonText: 'Guardar'
        }).then(result => {
          if (result.isConfirmed) {
            const nombre = document.getElementById('editNombreHito').value;
            const descripcion = document.getElementById('editDescripcionHito').value;
            const fecha = document.getElementById('editFechaHito').value;
            const estado = document.getElementById('editEstadoHito').value;

            if (!nombre || !fecha) {
              Swal.fire('Error', 'Nombre y fecha son requeridos', 'error');
              return;
            }

            fetch(`/api/hitos/${id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({
                nombre,
                descripcion,
                fecha_objetivo: fecha,
                estado,
                fecha_completacion: estado === 'Completado' ? new Date().toISOString().split('T')[0] : null
              })
            })
            .then(r => r.json())
            .then(data => {
              if (data.success) {
                Swal.fire('Éxito', 'Hito actualizado', 'success');
                cargarProyectos();
              } else {
                Swal.fire('Error', data.message || 'No se pudo actualizar', 'error');
              }
            });
          }
        });
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error', 'Error al cargar el hito', 'error');
      });
  }

  function editarActividad(id) {
    // Obtener datos de la actividad
    fetch(`/api/actividades/${id}`, { credentials: 'include' })
      .then(r => r.json())
      .then(data => {
        if (!data.success) {
          Swal.fire('Error', 'No se pudo cargar la actividad', 'error');
          return;
        }

        const actividad = data.data;
        const proyecto_id = actividad.proyecto_id;

        Swal.fire({
          title: `Editar Actividad: ${actividad.titulo}`,
          html: `
            <div class="text-left">
              <div class="form-group">
                <label>Título</label>
                <input type="text" id="editTituloActividad" class="form-control" value="${actividad.titulo}">
              </div>
              <div class="form-group">
                <label>Descripción</label>
                <textarea id="editDescripcionActividad" class="form-control" rows="2">${actividad.descripcion || ''}</textarea>
              </div>
              <div class="form-group">
                <label>Estado</label>
                <select id="editEstadoActividad" class="form-control">
                  <option value="Pendiente" ${actividad.estado === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                  <option value="En Progreso" ${actividad.estado === 'En Progreso' ? 'selected' : ''}>En Progreso</option>
                  <option value="En Revisión" ${actividad.estado === 'En Revisión' ? 'selected' : ''}>En Revisión</option>
                  <option value="Completada" ${actividad.estado === 'Completada' ? 'selected' : ''}>Completada</option>
                </select>
              </div>
              <div class="form-group">
                <label>Prioridad</label>
                <select id="editPrioridadActividad" class="form-control">
                  <option value="Baja" ${actividad.prioridad === 'Baja' ? 'selected' : ''}>Baja</option>
                  <option value="Media" ${actividad.prioridad === 'Media' ? 'selected' : ''}>Media</option>
                  <option value="Alta" ${actividad.prioridad === 'Alta' ? 'selected' : ''}>Alta</option>
                  <option value="Urgente" ${actividad.prioridad === 'Urgente' ? 'selected' : ''}>Urgente</option>
                </select>
              </div>
              <div class="form-group">
                <label>Horas Estimadas</label>
                <input type="number" id="editHorasEstActividad" class="form-control" value="${actividad.horas_estimadas || 0}" step="0.5">
              </div>
              <div class="form-group">
                <label>Horas Invertidas</label>
                <input type="number" id="editHorasInvActividad" class="form-control" value="${actividad.horas_invertidas || 0}" step="0.5">
              </div>
              <div class="form-group">
                <label>Fecha Vencimiento</label>
                <input type="date" id="editFechaVencActividad" class="form-control" value="${actividad.fecha_vencimiento ? actividad.fecha_vencimiento.split(' ')[0] : ''}">
              </div>
            </div>
          `,
          showCancelButton: true,
          confirmButtonText: 'Guardar',
          width: '600px'
        }).then(result => {
          if (result.isConfirmed) {
            const titulo = document.getElementById('editTituloActividad').value;
            const descripcion = document.getElementById('editDescripcionActividad').value;
            const estado = document.getElementById('editEstadoActividad').value;
            const prioridad = document.getElementById('editPrioridadActividad').value;
            const horasEst = document.getElementById('editHorasEstActividad').value;
            const horasInv = document.getElementById('editHorasInvActividad').value;
            const fechaVenc = document.getElementById('editFechaVencActividad').value;

            if (!titulo) {
              Swal.fire('Error', 'Título es requerido', 'error');
              return;
            }

            fetch(`/api/actividades/${id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({
                titulo,
                descripcion,
                estado,
                prioridad,
                horas_estimadas: horasEst || 0,
                horas_invertidas: horasInv || 0,
                fecha_vencimiento: fechaVenc || null
              })
            })
            .then(r => r.json())
            .then(data => {
              if (data.success) {
                Swal.fire('Éxito', 'Actividad actualizada', 'success');
                cargarProyectos();
              } else {
                Swal.fire('Error', data.message || 'No se pudo actualizar', 'error');
              }
            });
          }
        });
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error', 'Error al cargar la actividad', 'error');
      });
  }

  function eliminarHito(id) {
    Swal.fire({
      title: '¿Eliminar hito?',
      showCancelButton: true,
      confirmButtonText: 'Sí, eliminar'
    }).then(result => {
      if (result.isConfirmed) {
        fetch(`/api/hitos/${id}`, { method: 'DELETE', credentials: 'include' })
          .then(r => r.json())
          .then(data => {
            if (data.success) {
              Swal.fire('Eliminado', 'Hito eliminado', 'success');
              cargarProyectos();
            }
          });
      }
    });
  }

  function eliminarActividad(id) {
    Swal.fire({
      title: '¿Eliminar actividad?',
      showCancelButton: true,
      confirmButtonText: 'Sí, eliminar'
    }).then(result => {
      if (result.isConfirmed) {
        fetch(`/api/actividades/${id}`, { method: 'DELETE', credentials: 'include' })
          .then(r => r.json())
          .then(data => {
            if (data.success) {
              Swal.fire('Eliminado', 'Actividad eliminada', 'success');
              cargarProyectos();
            }
          });
      }
    });
  }
</script>
