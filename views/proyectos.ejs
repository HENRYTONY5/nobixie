<%- include("template/header") %>
<%- include("template/navbar") %>
<%- include("template/aside") %> 

<!-- Content Wrapper -->
<div class="content-wrapper">
  <%- include('template/breadcrumb', {module: 'Gestión de Proyectos'}) %>
  
  <!-- Content Header -->
  <section class="content-header">
    <div class="container-fluid">
      <!-- TARJETA PRINCIPAL INTRO -->
      <div class="row mb-4">
        <div class="col-md-12">
          <div class="card border-0 shadow-lg" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); border-radius: 15px;">
            <div class="card-body text-white p-5">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <div style="font-size: 3rem; margin-right: 20px;">
                    <i class="fas fa-tasks"></i>
                  </div>
                  <div>
                    <h2 class="card-title mb-2" style="font-weight: 700;">Gestión de Proyectos</h2>
                    <p class="mb-0 text-white-50">Registra y administra todos tus proyectos con descripción detallada.</p>
                  </div>
                </div>
                <button class="btn btn-primary btn-lg" onclick="abrirModalNuevoProyecto()" style="font-weight: 600;">
                  <i class="fas fa-plus mr-2"></i> Nuevo Proyecto
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ESTADÍSTICAS -->
      <div class="row mb-4" id="estadisticasProyectos">
        <div class="col-lg-3 col-md-6 mb-2">
          <div class="card border-0 shadow-sm text-center p-3">
            <div style="font-size: 2.5rem; color: #8b5cf6; margin-bottom: 10px;">
              <i class="fas fa-cube"></i>
            </div>
            <h3 id="totalProyectos" class="mb-1" style="font-weight: 700;">0</h3>
            <p class="text-muted mb-0">Total Proyectos</p>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-2">
          <div class="card border-0 shadow-sm text-center p-3">
            <div style="font-size: 2.5rem; color: #3b82f6; margin-bottom: 10px;">
              <i class="fas fa-play"></i>
            </div>
            <h3 id="enEjecucion" class="mb-1" style="font-weight: 700;">0</h3>
            <p class="text-muted mb-0">En Ejecución</p>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-2">
          <div class="card border-0 shadow-sm text-center p-3">
            <div style="font-size: 2.5rem; color: #10b981; margin-bottom: 10px;">
              <i class="fas fa-check-circle"></i>
            </div>
            <h3 id="finalizados" class="mb-1" style="font-weight: 700;">0</h3>
            <p class="text-muted mb-0">Finalizados</p>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-2">
          <div class="card border-0 shadow-sm text-center p-3">
            <div style="font-size: 2.5rem; color: #f59e0b; margin-bottom: 10px;">
              <i class="fas fa-pause-circle"></i>
            </div>
            <h3 id="enPausa" class="mb-1" style="font-weight: 700;">0</h3>
            <p class="text-muted mb-0">En Pausa</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Main content -->
  <section class="content">
    <div class="container-fluid">
      <!-- FILTRO DE ESTADOS -->
      <div class="row mb-3">
        <div class="col-md-12">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <label class="font-weight-600 mb-2">Filtrar por estado:</label>
              <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm btn-outline-primary active" onclick="filtrarProyectos('todos')">Todos</button>
                <button type="button" class="btn btn-sm btn-outline-info" onclick="filtrarProyectos('En Ejecución')">En Ejecución</button>
                <button type="button" class="btn btn-sm btn-outline-success" onclick="filtrarProyectos('Finalizado')">Finalizados</button>
                <button type="button" class="btn btn-sm btn-outline-warning" onclick="filtrarProyectos('Pausa')">En Pausa</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- LISTA DE PROYECTOS -->
      <div class="row" id="contenedorProyectos">
        <div class="col-md-12">
          <div class="card border-0 shadow-sm text-center p-5">
            <div class="spinner-border text-primary" role="status">
              <span class="sr-only">Cargando...</span>
            </div>
            <p class="mt-3 text-muted">Cargando proyectos...</p>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<%- include("template/footer") %>

<script>
  let proyectosData = [];
  let filtroActual = 'todos';
  let supervisoresData = [];

  document.addEventListener('DOMContentLoaded', function() {
    cargarSupervisores();
    cargarProyectos();
  });

  function cargarSupervisores() {
    fetch('/api/supervisores', { credentials: 'include' })
      .then(response => response.json())
      .then(data => {
        if (data.success && Array.isArray(data.supervisores)) {
          supervisoresData = data.supervisores;
        }
      })
      .catch(error => console.error('Error al cargar supervisores:', error));
  }

  function cargarProyectos() {
    fetch('/api/proyectos', { credentials: 'include' })
      .then(response => response.json())
      .then(data => {
        if (data.success && Array.isArray(data.data)) {
          proyectosData = data.data;
          actualizarEstadisticas();
          mostrarProyectos(proyectosData);
        } else {
          document.getElementById('contenedorProyectos').innerHTML = `
            <div class="col-md-12">
              <div class="alert alert-warning text-center">
                <i class="fas fa-exclamation-circle mr-2"></i>No hay proyectos registrados
              </div>
            </div>
          `;
        }
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('contenedorProyectos').innerHTML = `
          <div class="col-md-12">
            <div class="alert alert-danger text-center">
              <i class="fas fa-exclamation-triangle mr-2"></i>Error al cargar los proyectos
            </div>
          </div>
        `;
      });
  }

  function actualizarEstadisticas() {
    const total = proyectosData.length;
    const enEjecucion = proyectosData.filter(p => p.estado === 'En Ejecución').length;
    const finalizados = proyectosData.filter(p => p.estado === 'Finalizado').length;
    const enPausa = proyectosData.filter(p => p.estado === 'Pausa').length;

    document.getElementById('totalProyectos').textContent = total;
    document.getElementById('enEjecucion').textContent = enEjecucion;
    document.getElementById('finalizados').textContent = finalizados;
    document.getElementById('enPausa').textContent = enPausa;
  }

  function mostrarProyectos(proyectos) {
    let html = '<div class="row">';

    proyectos.forEach(proyecto => {
      const colorEstado = obtenerColorEstado(proyecto.estado);
      const iconoEstado = obtenerIconoEstado(proyecto.estado);
      
      html += `
        <div class="col-lg-6 col-md-12 mb-3">
          <div class="card border-0 shadow h-100" style="border-radius: 12px;">
            <div style="background: ${colorEstado}; padding: 20px; color: white; border-radius: 12px 12px 0 0;">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h5 class="mb-2" style="font-weight: 700;">
                    <i class="fas fa-folder-open mr-2"></i>${proyecto.nombre_proyecto}
                  </h5>
                  <p class="mb-0 text-white-50 small">
                    <i class="fas fa-user mr-1"></i>${proyecto.cliente}
                  </p>
                </div>
                <span class="badge badge-light" style="font-size: 0.9rem; padding: 6px 10px;">
                  ${iconoEstado} ${proyecto.estado}
                </span>
              </div>
            </div>

            <div class="card-body">
              <div class="mb-3">
                <label class="font-weight-600 small text-muted">DESCRIPCIÓN:</label>
                <p class="text-sm">${proyecto.descripcion || 'Sin descripción'}</p>
              </div>

              <div class="row text-sm">
                <div class="col-6">
                  <div class="mb-2">
                    <strong class="text-muted">Encargado:</strong><br>
                    <span>${proyecto.encargado || 'No asignado'}</span>
                  </div>
                </div>
                <div class="col-6">
                  <div class="mb-2">
                    <strong class="text-muted">Presupuesto:</strong><br>
                    <span>$${parseFloat(proyecto.presupuesto_estimado || 0).toLocaleString('es-MX', {maximumFractionDigits: 2})}</span>
                  </div>
                </div>
                <div class="col-6">
                  <div class="mb-2">
                    <strong class="text-muted">Avance:</strong><br>
                    <div class="progress progress-sm">
                      <div class="progress-bar" style="width: ${proyecto.porcentaje_avance || 0}%; background-color: ${colorEstado}"></div>
                    </div>
                    <small>${proyecto.porcentaje_avance || 0}%</small>
                  </div>
                </div>
                <div class="col-6">
                  <div class="mb-2">
                    <strong class="text-muted">Término:</strong><br>
                    <span>${proyecto.fecha_termino_prevista ? new Date(proyecto.fecha_termino_prevista).toLocaleDateString('es-MX') : 'Sin fecha'}</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="card-footer bg-white">
              <div class="row">
                <div class="col-6">
                  <button class="btn btn-sm btn-warning text-white w-100" onclick="editarProyecto(${proyecto.id}, '${proyecto.nombre_proyecto.replace(/'/g, "&apos;")}')" style="font-weight: 600;">
                    <i class="fas fa-edit mr-1"></i> Editar
                  </button>
                </div>
                <div class="col-6">
                  <button class="btn btn-sm btn-danger text-white w-100" onclick="eliminarProyecto(${proyecto.id}, '${proyecto.nombre_proyecto.replace(/'/g, "&apos;")}')" style="font-weight: 600;">
                    <i class="fas fa-trash mr-1"></i> Eliminar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    });

    html += '</div>';
    document.getElementById('contenedorProyectos').innerHTML = html;
  }

  function obtenerColorEstado(estado) {
    const colores = {
      'Levantamiento': 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)',
      'Cotización': 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
      'Aprobado': 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
      'En Ejecución': 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)',
      'Pausa': 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
      'Finalizado': 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
      'Cancelado': 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'
    };
    return colores[estado] || 'linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%)';
  }

  function obtenerIconoEstado(estado) {
    const iconos = {
      'Levantamiento': '<i class="fas fa-pencil-alt"></i>',
      'Cotización': '<i class="fas fa-file-invoice-dollar"></i>',
      'Aprobado': '<i class="fas fa-check"></i>',
      'En Ejecución': '<i class="fas fa-play"></i>',
      'Pausa': '<i class="fas fa-pause"></i>',
      'Finalizado': '<i class="fas fa-trophy"></i>',
      'Cancelado': '<i class="fas fa-ban"></i>'
    };
    return iconos[estado] || '<i class="fas fa-cube"></i>';
  }

  function filtrarProyectos(filtro) {
    filtroActual = filtro;
    
    let proyectosFiltrados = proyectosData;
    if (filtro !== 'todos') {
      proyectosFiltrados = proyectosData.filter(p => p.estado === filtro);
    }

    mostrarProyectos(proyectosFiltrados);
  }

  function abrirModalNuevoProyecto() {
    let htmlSupervisores = supervisoresData.map(s => `<option value="${s.id}">${s.nombre_supervisor}</option>`).join('');

    Swal.fire({
      title: '<strong>Nuevo Proyecto</strong>',
      html: `
        <div class="text-left">
          <div class="form-group mb-3">
            <label class="font-weight-600">Nombre del Proyecto:</label>
            <input type="text" id="nombreProyecto" class="form-control" placeholder="Ingresa el nombre">
          </div>
          <div class="form-group mb-3">
            <label class="font-weight-600">Cliente:</label>
            <input type="text" id="clienteProyecto" class="form-control" placeholder="Ingresa el cliente">
          </div>
          <div class="form-group mb-3">
            <label class="font-weight-600">Descripción:</label>
            <textarea id="descripcionProyecto" class="form-control" rows="3" placeholder="Describe el proyecto..."></textarea>
          </div>
          <div class="form-group mb-3">
            <label class="font-weight-600">Presupuesto Estimado:</label>
            <input type="number" id="presupuestoProyecto" class="form-control" placeholder="0.00" step="0.01">
          </div>
          <div class="form-group mb-3">
            <label class="font-weight-600">Supervisor (Encargado):</label>
            <select id="supervisorProyecto" class="form-control" onchange="cargarEmpleadosSupervisor()">
              <option value="">Selecciona un supervisor...</option>
              ${htmlSupervisores}
            </select>
          </div>
          <div class="form-group mb-3">
            <label class="font-weight-600">Empleados que Participan:</label>
            <div id="empleadosProyecto" class="border rounded p-2" style="max-height: 200px; overflow-y: auto; background-color: #f8f9fa;">
              <small class="text-muted">Selecciona un supervisor primero</small>
            </div>
          </div>
        </div>
      `,
      icon: 'info',
      showCancelButton: true,
      confirmButtonColor: '#10b981',
      cancelButtonColor: '#6c757d',
      confirmButtonText: '<i class="fas fa-save mr-2"></i>Crear Proyecto',
      cancelButtonText: 'Cancelar',
      width: '600px'
    }).then((result) => {
      if (result.isConfirmed) {
        guardarNuevoProyecto();
      }
    });
  }

  function cargarEmpleadosSupervisor() {
    const supervisorId = document.getElementById('supervisorProyecto').value;
    const contenedor = document.getElementById('empleadosProyecto');

    if (!supervisorId) {
      contenedor.innerHTML = '<small class="text-muted">Selecciona un supervisor primero</small>';
      return;
    }

    const supervisor = supervisoresData.find(s => s.id == supervisorId);
    if (!supervisor || !supervisor.empleados || supervisor.empleados.length === 0) {
      contenedor.innerHTML = '<small class="text-danger">Este supervisor no tiene empleados asignados</small>';
      return;
    }

    let html = '<div class="list-group">';
    supervisor.empleados.forEach(emp => {
      html += `
        <label class="list-group-item">
          <input type="checkbox" class="empleado-checkbox" value="${emp.id}" data-nombre="${emp.nombre}">
          <span>${emp.nombre} - ${emp.puesto}</span>
        </label>
      `;
    });
    html += '</div>';
    contenedor.innerHTML = html;
  }

  function guardarNuevoProyecto() {
    const nombre = document.getElementById('nombreProyecto').value;
    const cliente = document.getElementById('clienteProyecto').value;
    const descripcion = document.getElementById('descripcionProyecto').value;
    const presupuesto = document.getElementById('presupuestoProyecto').value;
    const supervisorId = document.getElementById('supervisorProyecto').value;

    if (!nombre || !cliente) {
      Swal.fire('Error', 'Nombre y cliente son requeridos', 'error');
      return;
    }

    const empleadosSeleccionados = Array.from(document.querySelectorAll('.empleado-checkbox:checked')).map(e => e.value);

    fetch('/api/proyectos', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        nombre_proyecto: nombre,
        cliente,
        descripcion,
        presupuesto_estimado: presupuesto || 0,
        encargado_id: supervisorId || null,
        empleados_participantes: empleadosSeleccionados
      })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          Swal.fire('Éxito', 'Proyecto creado correctamente', 'success').then(() => {
            cargarProyectos();
          });
        } else {
          Swal.fire('Error', data.message || 'No se pudo crear el proyecto', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error', 'Error al crear el proyecto', 'error');
      });
  }

  function editarProyecto(id, nombre) {
    const proyecto = proyectosData.find(p => p.id === id);
    if (!proyecto) return;

    let htmlSupervisores = supervisoresData.map(s => `<option value="${s.id}" ${proyecto.encargado_id == s.id ? 'selected' : ''}>${s.nombre_supervisor}</option>`).join('');

    Swal.fire({
      title: `<strong>Editar: ${nombre}</strong>`,
      html: `
        <div class="text-left">
          <div class="form-group mb-3">
            <label class="font-weight-600">Nombre:</label>
            <input type="text" id="editNombreProyecto" class="form-control" value="${proyecto.nombre_proyecto}">
          </div>
          <div class="form-group mb-3">
            <label class="font-weight-600">Descripción:</label>
            <textarea id="editDescripcionProyecto" class="form-control" rows="3">${proyecto.descripcion || ''}</textarea>
          </div>
          <div class="form-group mb-3">
            <label class="font-weight-600">Estado:</label>
            <select id="editEstadoProyecto" class="form-control">
              <option value="Levantamiento" ${proyecto.estado === 'Levantamiento' ? 'selected' : ''}>Levantamiento</option>
              <option value="Cotización" ${proyecto.estado === 'Cotización' ? 'selected' : ''}>Cotización</option>
              <option value="Aprobado" ${proyecto.estado === 'Aprobado' ? 'selected' : ''}>Aprobado</option>
              <option value="En Ejecución" ${proyecto.estado === 'En Ejecución' ? 'selected' : ''}>En Ejecución</option>
              <option value="Pausa" ${proyecto.estado === 'Pausa' ? 'selected' : ''}>Pausa</option>
              <option value="Finalizado" ${proyecto.estado === 'Finalizado' ? 'selected' : ''}>Finalizado</option>
              <option value="Cancelado" ${proyecto.estado === 'Cancelado' ? 'selected' : ''}>Cancelado</option>
            </select>
          </div>
          <div class="form-group mb-3">
            <label class="font-weight-600">Porcentaje Avance:</label>
            <input type="number" id="editAvanceProyecto" class="form-control" value="${proyecto.porcentaje_avance || 0}" min="0" max="100">
          </div>
          <div class="form-group mb-3">
            <label class="font-weight-600">Supervisor:</label>
            <select id="editSupervisorProyecto" class="form-control">
              <option value="">Sin supervisor</option>
              ${htmlSupervisores}
            </select>
          </div>
        </div>
      `,
      icon: 'info',
      showCancelButton: true,
      confirmButtonColor: '#f59e0b',
      cancelButtonColor: '#6c757d',
      confirmButtonText: '<i class="fas fa-save mr-2"></i>Guardar Cambios',
      cancelButtonText: 'Cancelar',
      width: '600px'
    }).then((result) => {
      if (result.isConfirmed) {
        actualizarProyecto(id);
      }
    });
  }

  function actualizarProyecto(id) {
    const nombre = document.getElementById('editNombreProyecto').value;
    const descripcion = document.getElementById('editDescripcionProyecto').value;
    const estado = document.getElementById('editEstadoProyecto').value;
    const avance = document.getElementById('editAvanceProyecto').value;
    const supervisorId = document.getElementById('editSupervisorProyecto').value;

    fetch(`/api/proyectos/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        nombre_proyecto: nombre,
        descripcion,
        estado,
        porcentaje_avance: avance,
        encargado_id: supervisorId || null
      })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          Swal.fire('Éxito', 'Proyecto actualizado correctamente', 'success').then(() => {
            cargarProyectos();
          });
        } else {
          Swal.fire('Error', data.message || 'No se pudo actualizar el proyecto', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error', 'Error al actualizar el proyecto', 'error');
      });
  }

  function eliminarProyecto(id, nombre) {
    Swal.fire({
      title: '¿Eliminar proyecto?',
      html: `<p>Vas a eliminar: <strong>${nombre}</strong></p>
             <p class="text-danger">Esta acción no se puede deshacer</p>`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#dc3545',
      cancelButtonColor: '#6c757d',
      confirmButtonText: '<i class="fas fa-trash mr-2"></i>Sí, eliminar',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        fetch(`/api/proyectos/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              Swal.fire('Eliminado', 'Proyecto eliminado correctamente', 'success').then(() => {
                cargarProyectos();
              });
            } else {
              Swal.fire('Error', data.message || 'No se pudo eliminar el proyecto', 'error');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            Swal.fire('Error', 'Error al eliminar el proyecto', 'error');
          });
      }
    });
  }
</script>
