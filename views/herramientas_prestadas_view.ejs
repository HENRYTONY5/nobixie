<%- include("template/header") %>
<%- include("template/navbar") %>
<%- include("template/aside") %>

<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
  <%- include('template/breadcrumb', { module: 'Herramientas Prestadas' }) %>

  <!-- Content Header -->
  <section class="content-header">
    <div class="container-fluid">

      <!-- Intro Card -->
      <div class="row mb-4">
        <div class="col-md-12">
          <div class="card border-0 shadow-lg" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 15px;">
            <div class="card-body text-white p-5">
              <div class="d-flex align-items-center">
                <div style="font-size: 3rem; margin-right: 20px;">
                  <i class="fas fa-handshake"></i>
                </div>
                <div>
                  <h2 class="card-title mb-2" style="font-weight: 700;">Control de Préstamos de Herramientas</h2>
                  <p class="mb-0 text-white-50">Gestiona todos los préstamos de herramientas por departamento y empleado.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Controles de Filtro y Búsqueda -->
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="form-group">
            <label style="font-weight: 600; color: #f59e0b;">
              <i class="fas fa-filter mr-2"></i>Filtrar por Departamento
            </label>
            <select class="form-control form-control-lg" id="selectDepartamento" onchange="filtrarPorDepartamento()" style="border-radius: 8px; border: 2px solid #f59e0b;">
              <option value="">-- Todos los departamentos --</option>
              <option value="Pailería">Pailería</option>
              <option value="Administración">Administración</option>
              <option value="Eléctricos">Eléctricos</option>
              <option value="Mantenimiento">Mantenimiento</option>
            </select>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-group">
            <label style="font-weight: 600; color: #f59e0b;">
              <i class="fas fa-search mr-2"></i>Buscar Herramienta/Empleado
            </label>
            <input type="text" class="form-control form-control-lg" id="inputBusqueda" placeholder="Buscar por herramienta, modelo, serie, marca o empleado..." 
                   onkeyup="buscarPrestamos()" style="border-radius: 8px; border: 2px solid #f59e0b;">
          </div>
        </div>
      </div>

      <!-- Botón Registrar Nuevo Préstamo -->
      <div class="row mb-4">
        <div class="col-md-12">
          <a href="/registrar-prestamo" class="btn btn-lg btn-warning" style="border-radius: 8px; font-weight: 600;">
            <i class="fas fa-plus mr-2"></i>Registrar Nuevo Préstamo
          </a>
        </div>
      </div>

      <!-- Contenedor de Entregas -->
      <div id="contenedorPrestamos" class="row">
        <!-- Los prestamos se cargan aquí dinámicamente -->
        <div class="col-md-12">
          <div class="alert alert-info text-center" role="alert">
            <i class="fas fa-spinner fa-spin mr-2"></i>Cargando prestamos...
          </div>
        </div>
      </div>

      <!-- Resumen Total -->
      <div id="resumenTotal" class="row mt-4" style="display: none;">
        <div class="col-md-12">
          <div class="card border-0 shadow-lg" style="border-radius: 12px; background: #f9fafb;">
            <div class="card-body">
              <h6 style="font-weight: 700; color: #f59e0b; margin-bottom: 15px;">
                <i class="fas fa-chart-pie mr-2"></i>Resumen de Préstamos
              </h6>
              <div class="row text-center">
                <div class="col-md-3">
                  <div style="padding: 10px; background: white; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <h4 id="totalPrestamos" style="color: #f59e0b; margin: 0;">0</h4>
                    <small class="text-muted">Total de Préstamos</small>
                  </div>
                </div>
                <div class="col-md-3">
                  <div style="padding: 10px; background: white; border-radius: 8px; border-left: 4px solid #ef4444;">
                    <h4 id="enPrestamo" style="color: #ef4444; margin: 0;">0</h4>
                    <small class="text-muted">En Préstamo</small>
                  </div>
                </div>
                <div class="col-md-3">
                  <div style="padding: 10px; background: white; border-radius: 8px; border-left: 4px solid #10b981;">
                    <h4 id="devueltos" style="color: #10b981; margin: 0;">0</h4>
                    <small class="text-muted">Devueltos</small>
                  </div>
                </div>
                <div class="col-md-3">
                  <div style="padding: 10px; background: white; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <h4 id="totalEmpleados" style="color: #3b82f6; margin: 0;">0</h4>
                    <small class="text-muted">Empleados</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- /.container-fluid -->
  </section>
  <!-- /.content -->
</div>
<!-- /.content-wrapper -->

<!-- Script -->
<script>
  let todosPrestamos = [];
  let prestamosFiltrados = [];

  // Cargar prestamos al cargar la página
  document.addEventListener('DOMContentLoaded', function() {
    cargarPrestamos();
  });

  function cargarPrestamos() {
    fetch('/api/herramientas-prestadas')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          todosPrestamos = data.prestamos || [];
          prestamosFiltrados = [...todosPrestamos];
          renderizarPrestamos();
        } else {
          mostrarError('Error al cargar los préstamos');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        mostrarError('Error al conectar con el servidor');
      });
  }

  function filtrarPorDepartamento() {
    const departamento = document.getElementById('selectDepartamento').value;
    const busqueda = document.getElementById('inputBusqueda').value.toLowerCase();

    prestamosFiltrados = todosPrestamos.filter(prestamo => {
      const coincideDepartamento = !departamento || prestamo.departamento === departamento;
      const coincideBusqueda = !busqueda || 
        prestamo.herramienta.toLowerCase().includes(busqueda) ||
        (prestamo.modelo && prestamo.modelo.toLowerCase().includes(busqueda)) ||
        (prestamo.numero_serie && prestamo.numero_serie.toLowerCase().includes(busqueda)) ||
        (prestamo.marca && prestamo.marca.toLowerCase().includes(busqueda)) ||
        prestamo.nombre.toLowerCase().includes(busqueda);

      return coincideDepartamento && coincideBusqueda;
    });

    renderizarPrestamos();
  }

  function buscarPrestamos() {
    filtrarPorDepartamento();
  }

  function renderizarPrestamos() {
    const contenedor = document.getElementById('contenedorPrestamos');

    if (prestamosFiltrados.length === 0) {
      contenedor.innerHTML = `
        <div class="col-md-12">
          <div class="alert alert-warning text-center" role="alert">
            <i class="fas fa-inbox mr-2"></i>No hay préstamos que mostrar
          </div>
        </div>
      `;
      document.getElementById('resumenTotal').style.display = 'none';
      return;
    }

    // Agrupar por empleado
    const prestamosPorEmpleado = {};
    prestamosFiltrados.forEach(prestamo => {
      const key = prestamo.empleado_id;
      if (!prestamosPorEmpleado[key]) {
        prestamosPorEmpleado[key] = {
          empleado_id: prestamo.empleado_id,
          nombre: prestamo.nombre,
          numero_empleado: prestamo.numero_empleado,
          email: prestamo.email,
          departamento: prestamo.departamento,
          prestamos: []
        };
      }
      prestamosPorEmpleado[key].prestamos.push(prestamo);
    });

    let html = '';
    Object.values(prestamosPorEmpleado).forEach(empleado => {
      html += `
        <div class="col-md-12 mb-4">
          <div class="card border-0 shadow-lg" style="border-radius: 12px; overflow: hidden;">
            <div class="card-header" style="background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%); color: white; padding: 15px; font-weight: 700;">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <i class="fas fa-user-circle mr-2" style="font-size: 1.5rem;"></i>
                  <strong>${empleado.nombre}</strong>
                  <span class="ml-3 badge badge-light">${empleado.numero_empleado}</span>
                  <span class="ml-2 badge badge-warning">${empleado.departamento}</span>
                </div>
                <span class="badge badge-light" style="font-size: 1rem;">${empleado.prestamos.length} préstamo(s)</span>
              </div>
            </div>
            <div class="card-body p-3">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead style="background-color: #f3f4f6;">
                    <tr>
                      <th style="width: 8%; color: #f59e0b; font-weight: 700;">ID</th>
                      <th style="color: #f59e0b; font-weight: 700;">Herramienta</th>
                      <th style="color: #f59e0b; font-weight: 700;">Modelo</th>
                      <th style="color: #f59e0b; font-weight: 700;">N° Serie</th>
                      <th style="color: #f59e0b; font-weight: 700;">Marca</th>
                      <th style="width: 15%; color: #f59e0b; font-weight: 700;">Fecha Préstamo</th>
                      <th style="width: 18%; color: #f59e0b; font-weight: 700;">Est. Devolución</th>
                      <th style="width: 12%; color: #f59e0b; font-weight: 700;">Estado</th>
                      <th style="width: 10%; color: #f59e0b; font-weight: 700;">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
      `;

      empleado.prestamos.forEach((prestamo, index) => {
        const fechaPrestamo = new Date(prestamo.fecha_prestamo).toLocaleDateString('es-MX');
        const fechaEstimada = prestamo.fecha_devolucion_estimada ? new Date(prestamo.fecha_devolucion_estimada).toLocaleDateString('es-MX') : '-';
        
        let estadoBadgeClass = 'badge-warning';
        let estadoIcon = '⏳';
        if (prestamo.estado === 'Devuelto') {
          estadoBadgeClass = 'badge-success';
          estadoIcon = '✓';
        } else if (prestamo.estado === 'Devuelto con Daño') {
          estadoBadgeClass = 'badge-danger';
          estadoIcon = '⚠';
        }

        html += `
          <tr>
            <td><strong>${prestamo.id}</strong></td>
            <td><strong>${prestamo.herramienta}</strong></td>
            <td><small class="text-muted">${prestamo.modelo || '-'}</small></td>
            <td><small class="text-muted">${prestamo.numero_serie || '-'}</small></td>
            <td><small class="text-muted">${prestamo.marca || '-'}</small></td>
            <td>${fechaPrestamo}</td>
            <td>${fechaEstimada}</td>
            <td><span class="badge ${estadoBadgeClass}">${estadoIcon} ${prestamo.estado}</span></td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-primary" title="Editar" onclick="editarPrestamo(${prestamo.id})">
                  <i class="fas fa-edit"></i>
                </button>
                <button type="button" class="btn btn-outline-success" title="Marcar como devuelto" onclick="marcarDevuelto(${prestamo.id})" ${prestamo.estado === 'Devuelto' || prestamo.estado === 'Devuelto con Daño' ? 'disabled' : ''}>
                  <i class="fas fa-check"></i>
                </button>
                <button type="button" class="btn btn-outline-danger" title="Eliminar" onclick="eliminarPrestamo(${prestamo.id})">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      });

      html += `
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      `;
    });

    contenedor.innerHTML = html;
    actualizarResumen();
    document.getElementById('resumenTotal').style.display = 'block';
  }

  function actualizarResumen() {
    const totalPrestamos = prestamosFiltrados.length;
    const enPrestamo = prestamosFiltrados.filter(p => p.estado === 'En Préstamo' || p.estado === 'Prestado').length;
    const devueltos = prestamosFiltrados.filter(p => p.estado === 'Devuelto' || p.estado === 'Devuelto con Daño').length;
    
    const empleadosUnicos = new Set(prestamosFiltrados.map(p => p.empleado_id)).size;

    document.getElementById('totalPrestamos').textContent = totalPrestamos;
    document.getElementById('enPrestamo').textContent = enPrestamo;
    document.getElementById('devueltos').textContent = devueltos;
    document.getElementById('totalEmpleados').textContent = empleadosUnicos;
  }

  function editarPrestamo(id) {
    // Redirigir a página de edición
    window.location.href = `/editar-prestamo/${id}`;
  }

  function marcarDevuelto(id) {
    Swal.fire({
      title: '¿Marcar como devuelto?',
      text: '¿Esta seguro que desea marcar este préstamo como devuelto?',
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'Sí, devolver',
      cancelButtonText: 'Cancelar',
      confirmButtonColor: '#10b981'
    }).then((result) => {
      if (result.isConfirmed) {
        // Actualizar estado a Devuelto
        const datos = {
          estado: 'Devuelto',
          fecha_devolucion_real: new Date().toISOString().split('T')[0]
        };

        fetch(`/api/herramientas-prestadas/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(datos)
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: '¡Devuelto!',
              text: 'El préstamo ha sido marcado como devuelto',
              confirmButtonColor: '#10b981'
            }).then(() => {
              cargarPrestamos();
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: data.message || 'Error al actualizar el préstamo'
            });
          }
        })
        .catch(error => {
          console.error('Error:', error);
          mostrarError('Error al actualizar');
        });
      }
    });
  }

  function eliminarPrestamo(id) {
    Swal.fire({
      title: '¿Eliminar préstamo?',
      text: 'Esta acción no se puede deshacer',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Sí, eliminar',
      cancelButtonText: 'Cancelar',
      confirmButtonColor: '#ef4444'
    }).then((result) => {
      if (result.isConfirmed) {
        fetch(`/api/herramientas-prestadas/${id}`, {
          method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: 'Eliminado',
              text: 'El préstamo ha sido eliminado',
              confirmButtonColor: '#ef4444'
            }).then(() => {
              cargarPrestamos();
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: data.message || 'Error al eliminar'
            });
          }
        })
        .catch(error => {
          console.error('Error:', error);
          mostrarError('Error al eliminar');
        });
      }
    });
  }

  function mostrarError(mensaje) {
    const contenedor = document.getElementById('contenedorPrestamos');
    contenedor.innerHTML = `
      <div class="col-md-12">
        <div class="alert alert-danger text-center" role="alert">
          <i class="fas fa-exclamation-circle mr-2"></i>${mensaje}
        </div>
      </div>
    `;
  }
</script>

<%- include("template/footer") %>
