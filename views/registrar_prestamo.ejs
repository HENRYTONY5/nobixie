<%- include("template/header") %>
<%- include("template/navbar") %>
<%- include("template/aside") %>

<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
  <%- include('template/breadcrumb', { module: 'Registrar Pr√©stamo' }) %>

  <!-- Content Header -->
  <section class="content-header">
    <div class="container-fluid">

      <!-- Intro Card -->
      <div class="row mb-4">
        <div class="col-md-12">
          <div class="card border-0 shadow-lg" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 15px;">
            <div class="card-body text-white p-5">
              <div class="d-flex align-items-center">
                <div style="font-size: 3rem; margin-right: 20px;">
                  <i class="fas fa-handshake"></i>
                </div>
                <div>
                  <h2 class="card-title mb-2" style="font-weight: 700;">Registrar Nuevo Pr√©stamo</h2>
                  <p class="mb-0 text-white-50">Asigna herramientas en pr√©stamo con detalles completos (modelo, serie, marca).</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Formulario Principal -->
      <div class="row mb-4">
        <div class="col-md-8">
          <div class="card border-0 shadow-lg" style="border-radius: 12px;">
            <div class="card-header bg-warning text-white" style="border-radius: 12px 12px 0 0;">
              <h5 class="mb-0" style="font-weight: 700;">
                <i class="fas fa-edit mr-2"></i>Datos del Pr√©stamo
              </h5>
            </div>
            <div class="card-body p-4">
              <form id="formRegistrarPrestamo">
                
                <!-- Folio (Autogenerado) -->
                <div class="row">
                  <div class="col-md-12">
                    <div class="form-group">
                      <label for="folio" style="font-weight: 600; color: #f59e0b;">
                        <i class="fas fa-barcode mr-1"></i>Folio <span class="badge badge-warning">Autogenerado</span>
                      </label>
                      <input type="text" class="form-control form-control-lg" id="folio" name="folio" 
                             placeholder="Generando..." style="border-radius: 8px; border: 2px solid #e5e7eb; background-color: #f3f4f6;" readonly required>
                      <small class="text-muted">El sistema asignar√° autom√°ticamente un folio √∫nico</small>
                    </div>
                  </div>
                </div>

                <!-- Departamento -->
                <div class="row">
                  <div class="col-md-12">
                    <div class="form-group">
                      <label for="departamento" style="font-weight: 600; color: #f59e0b;">
                        <i class="fas fa-building mr-1"></i>Departamento <span class="text-danger">*</span>
                      </label>
                      <select class="form-control form-control-lg" id="departamento" name="departamento" 
                              style="border-radius: 8px; border: 2px solid #e5e7eb;" required onchange="filtrarEmpleadosPorDepartamento()">
                        <option value="">-- Seleccionar departamento primero --</option>
                        <option value="Pailer√≠a">Pailer√≠a</option>
                        <option value="Administraci√≥n">Administraci√≥n</option>
                        <option value="El√©ctricos">El√©ctricos</option>
                        <option value="Mantenimiento">Mantenimiento</option>
                      </select>
                      <small class="text-muted">Selecciona el departamento (filtra empleados)</small>
                    </div>
                  </div>
                </div>

                <!-- Herramienta -->
                <div class="row">
                  <div class="col-md-12">
                    <div class="form-group">
                      <label for="herramienta" style="font-weight: 600; color: #f59e0b;">
                        <i class="fas fa-hammer mr-1"></i>Herramienta <span class="text-danger">*</span>
                      </label>
                      <input type="text" class="form-control form-control-lg" id="herramienta" name="herramienta" 
                             placeholder="Ej: Mult√≠metro Digital" style="border-radius: 8px; border: 2px solid #e5e7eb;" required>
                      <small class="text-muted">Nombre o descripci√≥n de la herramienta</small>
                    </div>
                  </div>
                </div>

                <!-- Modelo, Serie, Marca -->
                <div class="row">
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="modelo" style="font-weight: 600; color: #f59e0b;">
                        <i class="fas fa-cube mr-1"></i>Modelo
                      </label>
                      <input type="text" class="form-control form-control-lg" id="modelo" name="modelo" 
                             placeholder="Ej: UT61E" style="border-radius: 8px; border: 2px solid #e5e7eb;">
                      <small class="text-muted">Modelo de la herramienta</small>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="numero_serie" style="font-weight: 600; color: #f59e0b;">
                        <i class="fas fa-hashtag mr-1"></i>N√∫mero de Serie
                      </label>
                      <input type="text" class="form-control form-control-lg" id="numero_serie" name="numero_serie" 
                             placeholder="Ej: MS123456" style="border-radius: 8px; border: 2px solid #e5e7eb;">
                      <small class="text-muted">N√∫mero de serie √∫nico</small>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="marca" style="font-weight: 600; color: #f59e0b;">
                        <i class="fas fa-tag mr-1"></i>Marca
                      </label>
                      <input type="text" class="form-control form-control-lg" id="marca" name="marca" 
                             placeholder="Ej: UNI-T" style="border-radius: 8px; border: 2px solid #e5e7eb;">
                      <small class="text-muted">Marca del fabricante</small>
                    </div>
                  </div>
                </div>

                <!-- Fecha Pr√©stamo y Estimada -->
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="fecha_prestamo" style="font-weight: 600; color: #f59e0b;">
                        <i class="fas fa-calendar mr-1"></i>Fecha de Pr√©stamo <span class="text-danger">*</span>
                      </label>
                      <input type="date" class="form-control form-control-lg" id="fecha_prestamo" name="fecha_prestamo" 
                             style="border-radius: 8px; border: 2px solid #e5e7eb;" required>
                      <small class="text-muted">Cu√°ndo se presta la herramienta</small>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="fecha_devolucion_estimada" style="font-weight: 600; color: #f59e0b;">
                        <i class="fas fa-calendar-alt mr-1"></i>Fecha de Devoluci√≥n Estimada
                      </label>
                      <input type="date" class="form-control form-control-lg" id="fecha_devolucion_estimada" name="fecha_devolucion_estimada" 
                             style="border-radius: 8px; border: 2px solid #e5e7eb;">
                      <small class="text-muted">Fecha estimada de devoluci√≥n</small>
                    </div>
                  </div>
                </div>

                <!-- Estado -->
                <div class="row">
                  <div class="col-md-12">
                    <div class="form-group">
                      <label for="estado" style="font-weight: 600; color: #f59e0b;">
                        <i class="fas fa-check-circle mr-1"></i>Estado
                      </label>
                      <select class="form-control form-control-lg" id="estado" name="estado" 
                              style="border-radius: 8px; border: 2px solid #e5e7eb;">
                        <option value="Prestado">üì§ Prestado (Reci√©n entregado)</option>
                        <option value="En Pr√©stamo">‚è≥ En Pr√©stamo (Activo)</option>
                        <option value="Devuelto">‚úì Devuelto</option>
                        <option value="Devuelto con Da√±o">‚ö† Devuelto con Da√±o</option>
                      </select>
                      <small class="text-muted">Estado actual del pr√©stamo</small>
                    </div>
                  </div>
                </div>

                <!-- Empleado (al final, filtrado por departamento) -->
                <div class="row">
                  <div class="col-md-12">
                    <div class="form-group">
                      <label for="empleado_id" style="font-weight: 600; color: #f59e0b;">
                        <i class="fas fa-user mr-1"></i>Empleado <span class="text-danger">*</span>
                      </label>
                      <select class="form-control form-control-lg" id="empleado_id" name="empleado_id" 
                              style="border-radius: 8px; border: 2px solid #e5e7eb;" required disabled>
                        <option value="">-- Primero selecciona un departamento --</option>
                      </select>
                      <small class="text-muted">Empleados filtrados por departamento seleccionado</small>
                    </div>
                  </div>
                </div>

                <!-- Descripci√≥n -->
                <div class="form-group">
                  <label for="descripcion" style="font-weight: 600; color: #f59e0b;">
                    <i class="fas fa-align-left mr-1"></i>Descripci√≥n
                  </label>
                  <textarea class="form-control" id="descripcion" name="descripcion" rows="2" 
                            placeholder="Detalles sobre la herramienta..." style="border-radius: 8px; border: 2px solid #e5e7eb;"></textarea>
                  <small class="text-muted">Informaci√≥n adicional sobre la herramienta</small>
                </div>

                <!-- Observaciones -->
                <div class="form-group">
                  <label for="observaciones" style="font-weight: 600; color: #f59e0b;">
                    <i class="fas fa-sticky-note mr-1"></i>Observaciones
                  </label>
                  <textarea class="form-control" id="observaciones" name="observaciones" rows="2" 
                            placeholder="Notas importantes..." style="border-radius: 8px; border: 2px solid #e5e7eb;"></textarea>
                  <small class="text-muted">Observaciones del responsable</small>
                </div>

              </form>
            </div>
          </div>
        </div>

        <!-- Herramientas Sugeridas -->
        <div class="col-md-4">
          <div class="card border-0 shadow-lg" style="border-radius: 12px;">
            <div class="card-header bg-warning text-white" style="border-radius: 12px 12px 0 0;">
              <h5 class="mb-0" style="font-weight: 700;">
                <i class="fas fa-lightbulb mr-2"></i>Herramientas Sugeridas
              </h5>
            </div>
            <div class="card-body p-3">
              <p class="text-muted small mb-3">Haz clic en una herramienta para agregarla r√°pidamente:</p>
              
              <div class="list-group">
                <!-- Herramienta Sugerida: Mult√≠metro -->
                <button type="button" class="list-group-item list-group-item-action border rounded mb-2 p-3" 
                        style="transition: all 0.3s; cursor: pointer; border-radius: 8px !important;"
                        onmouseover="this.style.backgroundColor='#fef3c7'; this.style.transform='translateX(5px)'"
                        onmouseout="this.style.backgroundColor='transparent'; this.style.transform='translateX(0)'"
                        onclick="agregarSugerida('Mult√≠metro Digital', 'UT61E', 'MS123456', 'UNI-T', 'El√©ctricos')">
                  <div class="d-flex align-items-center">
                    <div style="font-size: 1.5rem; color: #f59e0b; margin-right: 10px;">
                      <i class="fas fa-tachometer-alt"></i>
                    </div>
                    <div class="text-left">
                      <strong>Mult√≠metro Digital</strong>
                      <br>
                      <small class="text-muted">UT61E | UNI-T</small>
                    </div>
                  </div>
                </button>

                <!-- Herramienta Sugerida: Pinza Amperim√©trica -->
                <button type="button" class="list-group-item list-group-item-action border rounded mb-2 p-3" 
                        style="transition: all 0.3s; cursor: pointer; border-radius: 8px !important;"
                        onmouseover="this.style.backgroundColor='#fef3c7'; this.style.transform='translateX(5px)'"
                        onmouseout="this.style.backgroundColor='transparent'; this.style.transform='translateX(0)'"
                        onclick="agregarSugerida('Pinza Amperim√©trica', 'AC-380', 'CM789012', 'Fluke', 'El√©ctricos')">
                  <div class="d-flex align-items-center">
                    <div style="font-size: 1.5rem; color: #f59e0b; margin-right: 10px;">
                      <i class="fas fa-grip-vertical"></i>
                    </div>
                    <div class="text-left">
                      <strong>Pinza Amperim√©trica</strong>
                      <br>
                      <small class="text-muted">AC-380 | Fluke</small>
                    </div>
                  </div>
                </button>

                <!-- Herramienta Sugerida: Osciloscopio -->
                <button type="button" class="list-group-item list-group-item-action border rounded mb-2 p-3" 
                        style="transition: all 0.3s; cursor: pointer; border-radius: 8px !important;"
                        onmouseover="this.style.backgroundColor='#fef3c7'; this.style.transform='translateX(5px)'"
                        onmouseout="this.style.backgroundColor='transparent'; this.style.transform='translateX(0)'"
                        onclick="agregarSugerida('Osciloscopio Port√°til', 'SDS1202X-E', 'DS345678', 'SIGLENT', 'El√©ctricos')">
                  <div class="d-flex align-items-center">
                    <div style="font-size: 1.5rem; color: #f59e0b; margin-right: 10px;">
                      <i class="fas fa-wave-square"></i>
                    </div>
                    <div class="text-left">
                      <strong>Osciloscopio Port√°til</strong>
                      <br>
                      <small class="text-muted">SDS1202X-E | SIGLENT</small>
                    </div>
                  </div>
                </button>

                <!-- Herramienta Sugerida: Soldadora -->
                <button type="button" class="list-group-item list-group-item-action border rounded mb-2 p-3" 
                        style="transition: all 0.3s; cursor: pointer; border-radius: 8px !important;"
                        onmouseover="this.style.backgroundColor='#fef3c7'; this.style.transform='translateX(5px)'"
                        onmouseout="this.style.backgroundColor='transparent'; this.style.transform='translateX(0)'"
                        onclick="agregarSugerida('Soldadora Port√°til', 'MMA-140', 'WD901234', 'Lincoln', 'Pailer√≠a')">
                  <div class="d-flex align-items-center">
                    <div style="font-size: 1.5rem; color: #f59e0b; margin-right: 10px;">
                      <i class="fas fa-fire"></i>
                    </div>
                    <div class="text-left">
                      <strong>Soldadora Port√°til</strong>
                      <br>
                      <small class="text-muted">MMA-140 | Lincoln</small>
                    </div>
                  </div>
                </button>

                <!-- Herramienta Sugerida: Amoladadora -->
                <button type="button" class="list-group-item list-group-item-action border rounded p-3" 
                        style="transition: all 0.3s; cursor: pointer; border-radius: 8px !important;"
                        onmouseover="this.style.backgroundColor='#fef3c7'; this.style.transform='translateX(5px)'"
                        onmouseout="this.style.backgroundColor='transparent'; this.style.transform='translateX(0)'"
                        onclick="agregarSugerida('Amoladadora Angular', 'AG100', 'GR567890', 'Bosch', 'Pailer√≠a')">
                  <div class="d-flex align-items-center">
                    <div style="font-size: 1.5rem; color: #f59e0b; margin-right: 10px;">
                      <i class="fas fa-fan"></i>
                    </div>
                    <div class="text-left">
                      <strong>Amoladadora Angular</strong>
                      <br>
                      <small class="text-muted">AG100 | Bosch</small>
                    </div>
                  </div>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Botones de Acci√≥n -->
      <div class="row mb-4">
        <div class="col-md-8 offset-md-2">
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-lg btn-warning" onclick="guardarPrestamo()" 
                    style="border-radius: 8px; font-weight: 600; flex: 1;">
              <i class="fas fa-save mr-2"></i>Guardar Pr√©stamo
            </button>
            <a href="/programers" class="btn btn-lg btn-secondary" style="border-radius: 8px; font-weight: 600; flex: 1;">
              <i class="fas fa-times mr-2"></i>Cancelar
            </a>
          </div>
        </div>
      </div>

    </div><!-- /.container-fluid -->
  </section>
  <!-- /.content -->
</div>
<!-- /.content-wrapper -->

<!-- Script -->
<script>
  let todosLosEmpleados = [];

  // Cargar empleados y generar folio al abrir la p√°gina
  document.addEventListener('DOMContentLoaded', function() {
    cargarEmpleados();
    generarFolio();
    // Establecer fecha de hoy como default
    document.getElementById('fecha_prestamo').valueAsDate = new Date();
  });

  function generarFolio() {
    // Generar folio autogenerado basado en timestamp
    const timestamp = Date.now();
    const folio = 'PRS-' + String(timestamp).slice(-6);
    document.getElementById('folio').value = folio;
  }

  function cargarEmpleados() {
    fetch('/api/empleados')
      .then(response => response.json())
      .then(data => {
        if (data.empleados) {
          todosLosEmpleados = data.empleados;
        }
      })
      .catch(error => console.error('Error:', error));
  }

  function filtrarEmpleadosPorDepartamento() {
    const departamento = document.getElementById('departamento').value;
    const selectEmpleado = document.getElementById('empleado_id');
    
    if (!departamento) {
      selectEmpleado.innerHTML = '<option value="">-- Primero selecciona un departamento --</option>';
      selectEmpleado.disabled = true;
      return;
    }

    const empleadosFiltrados = todosLosEmpleados.filter(emp => emp.departamento === departamento);
    
    selectEmpleado.innerHTML = '<option value="">-- Seleccionar empleado --</option>';
    
    if (empleadosFiltrados.length > 0) {
      empleadosFiltrados.forEach(emp => {
        const option = document.createElement('option');
        option.value = emp.id;
        option.textContent = `${emp.nombre} (${emp.numero_empleado})`;
        selectEmpleado.appendChild(option);
      });
      selectEmpleado.disabled = false;
    } else {
      selectEmpleado.innerHTML = '<option value="">-- No hay empleados en este departamento --</option>';
      selectEmpleado.disabled = true;
    }
  }

  function agregarSugerida(herramienta, modelo, numero_serie, marca, departamento) {
    document.getElementById('herramienta').value = herramienta;
    document.getElementById('modelo').value = modelo;
    document.getElementById('numero_serie').value = numero_serie;
    document.getElementById('marca').value = marca;
    document.getElementById('departamento').value = departamento;
    filtrarEmpleadosPorDepartamento();
    document.getElementById('herramienta').focus();
  }

  function guardarPrestamo() {
    const form = document.getElementById('formRegistrarPrestamo');
    
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }

    const datos = {
      folio: document.getElementById('folio').value,
      empleado_id: document.getElementById('empleado_id').value,
      herramienta: document.getElementById('herramienta').value,
      modelo: document.getElementById('modelo').value || null,
      numero_serie: document.getElementById('numero_serie').value || null,
      marca: document.getElementById('marca').value || null,
      descripcion: document.getElementById('descripcion').value || null,
      departamento: document.getElementById('departamento').value,
      fecha_prestamo: document.getElementById('fecha_prestamo').value,
      fecha_devolucion_estimada: document.getElementById('fecha_devolucion_estimada').value || null,
      estado: document.getElementById('estado').value,
      observaciones: document.getElementById('observaciones').value || null
    };

    fetch('/api/herramientas-prestadas', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(datos)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        let timerInterval;
        Swal.fire({
          icon: 'success',
          title: '¬°Pr√©stamo Registrado!',
          html: 'El pr√©stamo se ha registrado correctamente.<br><small>Esta ventana se cerrar√° en <b></b> segundos</small>',
          timer: 5000,
          timerProgressBar: true,
          showCancelButton: true,
          confirmButtonText: '<i class="fas fa-plus"></i> Agregar m√°s',
          cancelButtonText: '<i class="fas fa-list"></i> Ver lista',
          confirmButtonColor: '#f59e0b',
          cancelButtonColor: '#2563eb',
          didOpen: () => {
            const b = Swal.getHtmlContainer().querySelector('b');
            timerInterval = setInterval(() => {
              b.textContent = Math.ceil(Swal.getTimerLeft() / 1000);
            }, 100);
          },
          willClose: () => {
            clearInterval(timerInterval);
          }
        }).then((result) => {
          if (result.isConfirmed) {
            // Agregar m√°s pr√©stamos
            document.getElementById('formRegistrarPrestamo').reset();
            generarFolio();
            document.getElementById('fecha_prestamo').valueAsDate = new Date();
            document.getElementById('empleado_id').disabled = true;
            window.scrollTo({ top: 0, behavior: 'smooth' });
          } else {
            // Ver lista de pr√©stamos
            window.location.href = '/herramientas-prestadas';
          }
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: data.message || 'Error al registrar el pr√©stamo'
        });
      }
    })
    .catch(error => {
      console.error('Error:', error);
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'Error al registrar el pr√©stamo'
      });
    });
  }
</script>

<%- include("template/footer") %>
