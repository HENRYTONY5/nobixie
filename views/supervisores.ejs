<%- include("template/header") %>
<%- include("template/navbar") %>
<%- include("template/aside") %>

<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
  <%- include('template/breadcrumb', { module: 'Supervisores' }) %>

  <!-- Content Header (Page header) -->
  <section class="content-header">
    <div class="container-fluid">
      <!-- TARJETA PRINCIPAL INTRO -->
      <div class="row mb-4">
        <div class="col-md-12">
          <div class="card border-0 shadow-lg" style="background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); border-radius: 15px;">
            <div class="card-body text-white p-5">
              <div class="d-flex align-items-center">
                <div style="font-size: 3rem; margin-right: 20px;">
                  <i class="fas fa-user-tie"></i>
                </div>
                <div>
                  <h2 class="card-title mb-2" style="font-weight: 700;">Gestión de Supervisores</h2>
                  <p class="mb-0 text-white-50">Visualiza todos los supervisores y los empleados bajo su mando.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- SECCIÓN LISTADO DE SUPERVISORES -->
      <div class="row mb-4" id="supervisoresContainer">
        <div class="col-md-12">
          <div class="card border-0 shadow-sm text-center p-5">
            <div class="spinner-border text-primary" role="status">
              <span class="sr-only">Cargando...</span>
            </div>
            <p class="mt-3 text-muted">Cargando supervisores...</p>
          </div>
        </div>
      </div>

    </div><!-- /.container-fluid -->
  </section>
  <!-- /.content -->
</div>
<!-- /.content-wrapper -->

<!-- MODAL ASIGNAR EMPLEADO -->
<div class="modal fade" id="modalAsignarEmpleadoSupervisores" tabindex="-1" role="dialog" aria-labelledby="modalAsignarEmpleadoLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="fas fa-user-plus mr-2"></i>Asignar Empleado a <span id="supervisorNombreAsignacion"></span>
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="supervisorIdAsignacion">

        <!-- SELECTOR DE TIPO DE ASIGNACIÓN -->
        <div class="form-group">
          <label for="tipoAsignacion" class="form-label"><strong>Tipo de Asignación:</strong></label>
          <select class="form-control form-control-lg" id="tipoAsignacion" onchange="mostrarTipoAsignacion()">
            <option value="individual">Empleado Individual</option>
            <option value="departamento">Departamento Completo</option>
          </select>
        </div>

        <hr>

        <!-- ASIGNACIÓN INDIVIDUAL -->
        <div id="asignacionIndividual">
          <div class="alert alert-info" role="alert">
            <i class="fas fa-info-circle mr-2"></i>
            <strong>Asignación Individual:</strong> Selecciona un empleado específico
          </div>

          <div class="form-group">
            <label for="empleadoSelectSupervisores" class="form-label"><strong>Empleado:</strong></label>
            <select class="form-control form-control-lg" id="empleadoSelectSupervisores" required>
              <option value="">-- Cargando empleados... --</option>
            </select>
          </div>

          <div class="form-group">
            <label for="departamentoIndividualSelect" class="form-label"><strong>Departamento:</strong></label>
            <select class="form-control form-control-lg" id="departamentoIndividualSelect" required>
              <option value="">-- Seleccione departamento --</option>
              <option value="Pailería">Pailería</option>
              <option value="Administración">Administración</option>
              <option value="Eléctricos">Eléctricos</option>
              <option value="Mantenimiento">Mantenimiento</option>
            </select>
          </div>
        </div>

        <!-- ASIGNACIÓN POR DEPARTAMENTO -->
        <div id="asignacionDepartamento" style="display: none;">
          <div class="alert alert-warning" role="alert">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <strong>Asignación Masiva:</strong> Se asignarán TODOS los empleados del departamento seleccionado
          </div>

          <div class="form-group">
            <label for="departamentoSelectSupervisores" class="form-label"><strong>Departamento a Asignar:</strong></label>
            <select class="form-control form-control-lg" id="departamentoSelectSupervisores" required>
              <option value="">-- Seleccione un departamento --</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          <i class="fas fa-times mr-1"></i>Cancelar
        </button>
        <button type="button" class="btn btn-success btn-lg" onclick="guardarAsignacionEmpleado()">
          <i class="fas fa-check mr-1"></i> Asignar
        </button>
      </div>
    </div>
  </div>
</div>

<%- include("template/footer") %>

<script>
  const departamentosDisponibles = ['Pailería', 'Administración', 'Eléctricos', 'Mantenimiento'];

  // Cargar supervisores al abrir la página
  $(document).ready(function() {
    cargarSupervisores();
  });

  function cargarSupervisores() {
    $.ajax({
      url: '/api/supervisores',
      method: 'GET',
      dataType: 'json',
      success: function(data) {
        if (data.success && Array.isArray(data.supervisores) && data.supervisores.length > 0) {
          mostrarSupervisores(data.supervisores);
          return;
        }

        const mensaje = data.message || 'No se pudieron cargar los supervisores';
        $('#supervisoresContainer').html(`
          <div class="col-md-12">
            <div class="alert alert-warning text-center">
              <i class="fas fa-exclamation-circle mr-2"></i>${mensaje}
            </div>
          </div>
        `);
      },
      error: function(xhr, status, error) {
        $('#supervisoresContainer').html(`
          <div class="col-md-12">
            <div class="alert alert-danger text-center">
              <i class="fas fa-exclamation-triangle mr-2"></i>
              <strong>Error al cargar los supervisores</strong><br>
              <small>Status: ${status} - ${error}</small>
            </div>
          </div>
        `);
      }
    });
  }

  function mostrarSupervisores(supervisores) {
    let html = '<div class="col-md-12"><div class="row">';

    supervisores.forEach(function(supervisor) {
      const cantidadEmpleados = supervisor.empleados ? supervisor.empleados.length : 0;
      const nombreSeguro = (supervisor.nombre_supervisor || '').replace(/'/g, "&apos;");

      html += '<div class="col-lg-6 col-md-12 mb-4">';
      html += '  <div class="card border-0 shadow h-100" style="border-radius: 12px;">';
      html += '    <div style="background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); padding: 25px; color: white;">';
      html += '      <div class="d-flex justify-content-between align-items-start">';
      html += '        <div>';
      html += '          <h5 class="mb-2" style="font-weight: 700;">';
      html += '            <i class="fas fa-user-tie mr-2"></i>' + supervisor.nombre_supervisor;
      html += '          </h5>';
      html += '          <p class="mb-0 text-white-50 small">';
      html += '            <i class="fas fa-envelope mr-1"></i>' + supervisor.email;
      html += '          </p>';
      html += '        </div>';
      html += '        <div>';
      html += '          <span class="badge badge-light" style="font-size: 1.1rem; padding: 8px 12px;">';
      html += cantidadEmpleados + ' empleado' + (cantidadEmpleados !== 1 ? 's' : '');
      html += '          </span>';
      html += '        </div>';
      html += '      </div>';
      html += '    </div>';

      html += '    <div class="card-body">';
      if (cantidadEmpleados > 0) {
        html += '      <table class="table table-sm table-hover">';
        html += '        <thead class="bg-light">';
        html += '          <tr>';
        html += '            <th>Número</th>';
        html += '            <th>Nombre</th>';
        html += '            <th>Puesto</th>';
        html += '            <th>Depto</th>';
        html += '          </tr>';
        html += '        </thead>';
        html += '        <tbody>';

        supervisor.empleados.forEach(function(emp) {
          html += '          <tr>';
          html += '            <td><span class="badge badge-primary">' + emp.numero_empleado + '</span></td>';
          html += '            <td><strong>' + emp.nombre + '</strong><br><small>' + emp.email + '</small></td>';
          html += '            <td>' + emp.puesto + '</td>';
          html += '            <td><span class="badge badge-info">' + emp.departamento + '</span></td>';
          html += '          </tr>';
        });

        html += '        </tbody>';
        html += '        </table>';
      } else {
        html += '      <div class="alert alert-warning mb-0">';
        html += '        <i class="fas fa-exclamation-circle mr-2"></i>No tiene empleados asignados aún';
        html += '      </div>';
      }
      html += '    </div>';

      html += '    <div class="card-footer bg-white">';
      html += '      <div class="row gap-2">';
      html += '        <div class="col">';
      html += '          <button class="btn btn-sm btn-warning text-white w-100 font-weight-600" onclick="abrirModalEditarSupervisor(' + supervisor.id + ', \'' + nombreSeguro + '\')" style="font-weight: 600;">';
      html += '            <i class="fas fa-edit mr-1"></i> Editar';
      html += '          </button>';
      html += '        </div>';
      html += '        <div class="col">';
      html += '          <button class="btn btn-sm btn-success text-white w-100 font-weight-600" onclick="abrirModalAsignarEmpleado(' + supervisor.id + ', \'' + nombreSeguro + '\')" style="font-weight: 600;">';
      html += '            <i class="fas fa-plus mr-1"></i> Asignar';
      html += '          </button>';
      html += '        </div>';
      html += '        <div class="col">';
      html += '          <button class="btn btn-sm btn-danger text-white w-100 font-weight-600" onclick="eliminarSupervisor(' + supervisor.id + ', \'' + nombreSeguro + '\')" style="font-weight: 600;">';
      html += '            <i class="fas fa-trash mr-1"></i> Eliminar';
      html += '          </button>';
      html += '        </div>';
      html += '      </div>';
      html += '    </div>';

      html += '  </div>';
      html += '</div>';
    });

    html += '</div></div>';
    $('#supervisoresContainer').html(html);
  }

  function abrirModalEditarSupervisor(supervisorId, nombre) {
    // Fetch para obtener datos del supervisor
    fetch(`/api/supervisores/${supervisorId}`, { credentials: 'include' })
      .then(response => {
        if (!response.ok) throw new Error('Error al obtener supervisor');
        return response.json();
      })
      .then(data => {
        if (!data.success || !data.supervisor) {
          Swal.fire('Error', 'No se pudo obtener la información del supervisor', 'error');
          return;
        }

        const supervisor = data.supervisor;
        const cantidadEmpleados = supervisor.empleados ? supervisor.empleados.length : 0;

        Swal.fire({
          title: `<strong>${nombre}</strong>`,
          html: `
            <div class="text-left">
              <div class="form-group mb-3">
                <label class="font-weight-600">ID:</label>
                <input type="text" class="form-control" value="${supervisor.id}" disabled>
              </div>
              <div class="form-group mb-3">
                <label class="font-weight-600">Email:</label>
                <input type="email" id="editEmail" class="form-control" value="${supervisor.email}">
              </div>
              <div class="form-group mb-3">
                <label class="font-weight-600">Nombre:</label>
                <input type="text" id="editNombre" class="form-control" value="${supervisor.nombre_supervisor}">
              </div>
              <div class="alert alert-info">
                <i class="fas fa-users mr-2"></i>
                <strong>${cantidadEmpleados}</strong> empleado${cantidadEmpleados !== 1 ? 's' : ''} asignado${cantidadEmpleados !== 1 ? 's' : ''}
              </div>
            </div>
          `,
          icon: 'info',
          showCancelButton: true,
          confirmButtonColor: '#f59e0b',
          cancelButtonColor: '#6c757d',
          confirmButtonText: '<i class="fas fa-save mr-2"></i>Guardar Cambios',
          cancelButtonText: 'Cancelar'
        }).then((result) => {
          if (result.isConfirmed) {
            guardarCambiosSupervisor(supervisorId, nombre);
          }
        });
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error', 'No se pudo cargar la información del supervisor', 'error');
      });
  }

  function guardarCambiosSupervisor(supervisorId, nombre) {
    const email = document.getElementById('editEmail').value;
    const nombreSupervisor = document.getElementById('editNombre').value;

    if (!email || !nombreSupervisor) {
      Swal.fire('Error', 'Los campos no pueden estar vacíos', 'error');
      return;
    }

    fetch(`/api/supervisores/${supervisorId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ email, nombre_supervisor: nombreSupervisor })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          Swal.fire('Éxito', 'Supervisor actualizado correctamente', 'success').then(() => {
            cargarSupervisores();
          });
        } else {
          Swal.fire('Error', data.message || 'No se pudo actualizar el supervisor', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error', 'Error al actualizar el supervisor', 'error');
      });
  }

  function eliminarSupervisor(supervisorId, nombre) {
    Swal.fire({
      title: '¿Eliminar supervisor?',
      html: `<p>Vas a eliminar a <strong>${nombre}</strong></p>
             <p class="text-danger">Esta acción no se puede deshacer</p>`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#dc3545',
      cancelButtonColor: '#6c757d',
      confirmButtonText: '<i class="fas fa-trash mr-2"></i>Sí, eliminar',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        fetch(`/api/supervisores/${supervisorId}`, {
          method: 'DELETE',
          credentials: 'include'
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              Swal.fire('Eliminado', 'Supervisor eliminado correctamente', 'success').then(() => {
                cargarSupervisores();
              });
            } else {
              Swal.fire('Error', data.message || 'No se pudo eliminar el supervisor', 'error');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            Swal.fire('Error', 'Error al eliminar el supervisor', 'error');
          });
      }
    });
  }

  function abrirModalAsignarEmpleado(supervisorId, supervisorNombre) {
    document.getElementById('supervisorIdAsignacion').value = supervisorId;
    document.getElementById('supervisorNombreAsignacion').textContent = supervisorNombre;

    cargarDepartamentos();
    cargarEmpleadosDisponibles();

    document.getElementById('tipoAsignacion').value = 'individual';
    mostrarTipoAsignacion();

    $('#modalAsignarEmpleadoSupervisores').modal('show');
  }

  function cargarEmpleadosDisponibles() {
    fetch('/api/empleados', { credentials: 'include' })
      .then(response => {
        if (!response.ok) {
          throw new Error('Error al cargar empleados');
        }
        return response.json();
      })
      .then(data => {
        const selectEmpleado = document.getElementById('empleadoSelectSupervisores');
        if (!selectEmpleado) {
          return;
        }

        selectEmpleado.innerHTML = '<option value="">-- Seleccione un empleado --</option>';
        if (data.success && Array.isArray(data.empleados) && data.empleados.length > 0) {
          data.empleados.forEach(emp => {
            const option = document.createElement('option');
            option.value = emp.id;
            option.textContent = `${emp.numero_empleado} - ${emp.nombre}`;
            selectEmpleado.appendChild(option);
          });
        } else {
          selectEmpleado.innerHTML = '<option value="">No hay empleados disponibles</option>';
        }
      })
      .catch(() => {
        const selectEmpleado = document.getElementById('empleadoSelectSupervisores');
        if (selectEmpleado) {
          selectEmpleado.innerHTML = '<option value="">Error al cargar empleados</option>';
        }
      });
  }

  function cargarDepartamentos() {
    const deptoSelect = document.getElementById('departamentoSelectSupervisores');
    const deptoIndividual = document.getElementById('departamentoIndividualSelect');

    if (deptoSelect) {
      deptoSelect.innerHTML = '<option value="">-- Seleccione un departamento --</option>';
      departamentosDisponibles.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept;
        option.textContent = dept;
        deptoSelect.appendChild(option);
      });
    }

    if (deptoIndividual) {
      deptoIndividual.innerHTML = '<option value="">-- Seleccione departamento --</option>';
      departamentosDisponibles.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept;
        option.textContent = dept;
        deptoIndividual.appendChild(option);
      });
    }
  }

  function mostrarTipoAsignacion() {
    const tipoAsignacion = document.getElementById('tipoAsignacion').value;
    const asignacionIndividual = document.getElementById('asignacionIndividual');
    const asignacionDepartamento = document.getElementById('asignacionDepartamento');

    if (tipoAsignacion === 'individual') {
      asignacionIndividual.style.display = 'block';
      asignacionDepartamento.style.display = 'none';
    } else {
      asignacionIndividual.style.display = 'none';
      asignacionDepartamento.style.display = 'block';
    }
  }

  function guardarAsignacionEmpleado() {
    const tipoAsignacion = document.getElementById('tipoAsignacion').value;
    if (tipoAsignacion === 'individual') {
      guardarAsignacionIndividual();
    } else {
      guardarAsignacionDepartamento();
    }
  }

  function guardarAsignacionIndividual() {
    const supervisorId = document.getElementById('supervisorIdAsignacion').value;
    const empleadoId = document.getElementById('empleadoSelectSupervisores').value;
    const departamento = document.getElementById('departamentoIndividualSelect').value;

    if (!supervisorId || !empleadoId || !departamento) {
      Swal.fire('Error', 'Debes seleccionar un empleado y un departamento', 'error');
      return;
    }

    fetch('/api/supervisores/asignar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ supervisor_id: supervisorId, empleado_id: empleadoId, departamento })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          Swal.fire('Éxito', 'Empleado asignado correctamente', 'success');
          $('#modalAsignarEmpleadoSupervisores').modal('hide');
          cargarSupervisores();
        } else {
          Swal.fire('Error', data.message || 'No se pudo asignar el empleado', 'error');
        }
      })
      .catch(() => {
        Swal.fire('Error', 'Error al asignar empleado', 'error');
      });
  }

  function guardarAsignacionDepartamento() {
    const supervisorId = document.getElementById('supervisorIdAsignacion').value;
    const departamento = document.getElementById('departamentoSelectSupervisores').value;

    if (!supervisorId || !departamento) {
      Swal.fire('Error', 'Debes seleccionar un departamento', 'error');
      return;
    }

    fetch('/api/supervisores/asignar-departamento', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ supervisor_id: supervisorId, departamento })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          Swal.fire('Éxito', 'Departamento asignado correctamente', 'success');
          $('#modalAsignarEmpleadoSupervisores').modal('hide');
          cargarSupervisores();
        } else {
          Swal.fire('Error', data.message || 'No se pudo asignar el departamento', 'error');
        }
      })
      .catch(() => {
        Swal.fire('Error', 'Error al asignar departamento', 'error');
      });
  }
</script>
