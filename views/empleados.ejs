<%- include("template/header") %>
<%- include("template/navbar") %>
<%- include("template/aside") %> 

<!-- Content Wrapper -->
<div class="content-wrapper">
  <%- include('template/breadcrumb', {module: 'Gestión de Empleados'}) %>
  
  <!-- Content Header -->
  <section class="content-header">
    <div class="container-fluid">
      <div class="row mb-4">
        <div class="col-md-12">
          <div class="d-flex justify-content-between align-items-center">
            <h1>Listado de Empleados</h1>
            <a href="/createData" class="btn btn-primary">
              <i class="fas fa-plus mr-2"></i> Nuevo Empleado
            </a>
          </div>
        </div>
      </div>

      <% if (alert) { %>
        <div class="alert alert-<%= alertIcon === 'error' ? 'danger' : alertIcon === 'success' ? 'success' : 'warning' %> alert-dismissible fade show" role="alert">
          <strong><%= alertTitle || 'Aviso' %>:</strong> <%= alertMessage %>
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
      <% } %>
    </div>
  </section>

  <!-- Main content -->
  <section class="content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-12">
          <div class="card card-primary shadow">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-users mr-2"></i>Tabla de Empleados
              </h3>
              <div class="card-tools">
                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                  <i class="fas fa-minus"></i>
                </button>
              </div>
            </div>

            <div class="card-body">
              <% if (empleados && empleados.length > 0) { %>
                <div class="table-responsive">
                  <table id="tablasEmpleados" class="table table-hover table-striped">
                    <thead class="bg-primary text-white">
                      <tr>
                        <th style="width: 5%">ID</th>
                        <th>Nombre</th>
                        <th>Email</th>
                        <th>Teléfono</th>
                        <th>RFC</th>
                        <th>Puesto</th>
                        <th>Tipo</th>
                        <th>Departamento</th>
                        <th>F. Ingreso</th>
                        <th style="width: 12%">Acciones</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% empleados.forEach(empleado => { %>
                        <tr>
                          <td><span class="badge badge-info"><%= empleado.id %></span></td>
                          <td><strong><%= empleado.nombre %></strong></td>
                          <td><%= empleado.email %></td>
                          <td><%= empleado.telefono || '-' %></td>
                          <td><code><%= empleado.rfc || '-' %></code></td>
                          <td><%= empleado.puesto %></td>
                          <td>
                            <% if (empleado.tipo_empleado === 'Administrativo') { %>
                              <span class="badge badge-secondary"><%= empleado.tipo_empleado %></span>
                            <% } else if (empleado.tipo_empleado === 'Supervisor') { %>
                              <span class="badge badge-warning"><%= empleado.tipo_empleado %></span>
                            <% } else { %>
                              <span class="badge badge-success"><%= empleado.tipo_empleado %></span>
                            <% } %>
                          </td>
                          <td>
                            <% if (empleado.departamento === 'Pailería') { %>
                              <span class="badge badge-info">Pailería</span>
                            <% } else if (empleado.departamento === 'Administración') { %>
                              <span class="badge badge-primary">Administración</span>
                            <% } else { %>
                              <span class="badge badge-danger">Eléctricos</span>
                            <% } %>
                          </td>
                          <td><%= empleado.fecha_ingreso ? new Date(empleado.fecha_ingreso).toLocaleDateString('es-MX') : '-' %></td>
                          <td>
                            <a href="#" class="btn btn-xs btn-info" title="Ver" data-id="<%= empleado.id %>">
                              <i class="fas fa-eye"></i>
                            </a>
                            <a href="#" class="btn btn-xs btn-warning" title="Editar" data-id="<%= empleado.id %>">
                              <i class="fas fa-edit"></i>
                            </a>
                            <a href="#" class="btn btn-xs btn-danger" title="Eliminar" data-id="<%= empleado.id %>" onclick="eliminarEmpleado(this)">
                              <i class="fas fa-trash"></i>
                            </a>
                          </td>
                        </tr>
                      <% }); %>
                    </tbody>
                  </table>
                </div>
              <% } else { %>
                <div class="alert alert-info text-center">
                  <i class="fas fa-inbox mr-2"></i>No hay empleados registrados aún.
                  <a href="/createData" class="alert-link"> Registrar uno ahora</a>
                </div>
              <% } %>
            </div>

            <div class="card-footer">
              <small class="text-muted">
                <i class="fas fa-info-circle mr-2"></i>
                Total de empleados: <strong><%= empleados ? empleados.length : 0 %></strong>
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<%- include("template/footer") %>

<style>
  .btn-xs {
    padding: 0.25rem 0.4rem;
    font-size: 0.75rem;
  }

  .table-responsive {
    border-radius: 0.25rem;
  }

  .badge {
    padding: 0.35rem 0.55rem;
  }
</style>

<script>
  $(function() {
    $('#tablasEmpleados').DataTable({
      "responsive": true,
      "lengthChange": true,
      "autoWidth": false,
      "searching": true,
      "paging": true,
      "ordering": true,
      "info": true,
      "buttons": [
        {
          extend: 'copy',
          text: '<i class="fas fa-copy mr-2"></i>Copiar',
          className: 'btn btn-sm btn-secondary'
        },
        {
          extend: 'csv',
          text: '<i class="fas fa-file-csv mr-2"></i>CSV',
          className: 'btn btn-sm btn-secondary',
          filename: 'empleados_' + new Date().toISOString().split('T')[0]
        },
        {
          extend: 'excel',
          text: '<i class="fas fa-file-excel mr-2"></i>Excel',
          className: 'btn btn-sm btn-secondary',
          filename: 'empleados_' + new Date().toISOString().split('T')[0]
        },
        {
          extend: 'pdf',
          text: '<i class="fas fa-file-pdf mr-2"></i>PDF',
          className: 'btn btn-sm btn-secondary',
          filename: 'empleados_' + new Date().toISOString().split('T')[0]
        },
        {
          extend: 'print',
          text: '<i class="fas fa-print mr-2"></i>Imprimir',
          className: 'btn btn-sm btn-secondary'
        },
        {
          extend: 'colvis',
          text: '<i class="fas fa-columns mr-2"></i>Columnas',
          className: 'btn btn-sm btn-secondary'
        }
      ],
      "language": {
        "sProcessing": "Procesando...",
        "sLengthMenu": "Mostrar _MENU_ registros",
        "sZeroRecords": "No se encontraron resultados",
        "sEmptyTable": "Ningún dato disponible en esta tabla",
        "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
        "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
        "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
        "sSearch": "Buscar:",
        "sPaginate": {
          "sFirst": "Primero",
          "sPrevious": "Anterior",
          "sNext": "Siguiente",
          "sLast": "Último"
        }
      }
    }).buttons().container().appendTo('#tablasEmpleados_wrapper .col-md-6:eq(0)');
  });

  function eliminarEmpleado(elemento) {
    const id = elemento.getAttribute('data-id');
    Swal.fire({
      title: '¿Eliminar empleado?',
      text: "Esta acción no se puede deshacer",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Sí, eliminar',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        fetch(`/api/empleados/${id}`, {
          method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
          Swal.fire('Eliminado', 'El empleado ha sido eliminado', 'success')
            .then(() => location.reload());
        })
        .catch(error => {
          Swal.fire('Error', error.message, 'error');
        });
      }
    });
  }
</script>
